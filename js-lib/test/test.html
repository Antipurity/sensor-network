
<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset=utf-8>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sensor Network Testing</title>
  <style>
    .hiding, .hidable, .hidingMarker, .hidingSurface { transition: .3s }
    .hidable { overflow: hidden }
    .hidingMarker { display: inline-block; position: relative; z-index: 0 }
    .isHiding>.hidingMarker { transform: rotate(90deg) }

    .hiding { position: relative }
    .hidingSurface { position:absolute; left:0; right:0; top:0; bottom:0; z-index: 1 }
    .hidingSurface:hover { box-shadow: 0 0 .1em black, 0 0 .1em inset black }
    .hidable { margin-left: 2em; box-shadow: -3px 0 1px black; position: relative; z-index: 2 }

    code { font-family: monospace, monospace }
    body { font-family: sans-serif }

    textarea, div.resizable { transition: none !important }
    div.resizable { resize:both; overflow:hidden; display:block }
  </style>
</head>
<body>
  <div>
    <div class="hiding isHiding">
      <div class=hidingSurface></div>
      <span class=hidingMarker>▶</span>
      Documentation
      <div class="hidable" style="height:0px" id=docs>···</div>
    </div>
  </div>
  <div class="hiding">
    <div class=hidingSurface></div>
    <span class=hidingMarker>▶</span>
    Tests
    <div class="hidable" id=tests>···</div>
  </div>
  <div class="hiding isHiding">
    <div class=hidingSurface></div>
    <span class=hidingMarker>▶</span>
    Benchmarks
    <div class="hidable" style="height:0px">
      <div class="hiding isHiding">
        <div class=hidingSurface></div>
        <span class=hidingMarker>▶</span>
        Paste JSON
        <div class="hidable" style="height:0px" id=json>
          <textarea rows=1 id=json-textarea></textarea>
        </div>
      </div>
      <br>
      <button style="width:100%" id=bench-button>Run all benchmarks (slow)</button>
      <br>
      (The mean per a global's sub-benchmark is displayed.)
      <div id=bench>
      </div>
      <div id=bench-progress></div>
    </div>
  </div>
  <script type=module>
    import sn from '../main.js'
    import './smooth-collapse.js'
    import display from './plots.js'
    import 'https://cdn.jsdelivr.net/npm/marked/marked.min.js'

    const secPerBenchmark = 10

    document.getElementById('docs').innerHTML = marked.parse(sn.meta.docs())
    sn.meta.tests().then(r => {
      const el = document.getElementById('tests')
      if (!r) el.textContent = 'OK'
      else {
        let html = `Failing:<br>`
        for (let [name, a, b] of r)
          html += `<div class="hiding isHiding"><div class=hidingSurface></div><span class=hidingMarker>▶</span>${name}<div class=hidable style="height:0px"><div></div><code>${a}</code><div> must equal</div><code>${b}</code></div></div>`
        el.innerHTML = html
      }
    })



    function updateJSON() {
      let obj
      try { obj = JSON.parse(this.value) }
      catch (err) { return }
      if (!obj) return
      const json = document.getElementById('json')
      for (let lbl of Object.keys(obj))
        try { display(json, lbl, 'empty'), display(json, lbl, obj[lbl]) }
        catch (err) { console.error(err) }
      for (let lbl of display(json))
        if (!(lbl in obj))
          display(json, lbl, undefined)
    }
    ;(document.getElementById('json-textarea').oninput = updateJSON).call(document.getElementById('json-textarea'))



    document.getElementById('bench-button').onclick = runBenchmarks
    async function runBenchmarks() {
      // TODO: Why are plots stupidly-big initially? Why are they not display:none?
      this.disabled = true
      const plots = document.getElementById('bench')
      const progressElem = document.getElementById('bench-progress')
      for (let lbl of display(plots))
        display(plots, lbl, undefined)
      progressElem.textContent = '0%'
      const start = performance.now()
      await sn.meta.bench(secPerBenchmark, obj => {
        return true
      }, (obj, id, got, progress) => {
        const elapsed = performance.now() - start
        progressElem.textContent = round(progress * 100) + '%; ETA: ' + (elapsed / progress - elapsed) + 's'
        for (let key of Object.keys(got))
          if (Array.isArray(got[key])) {
            // Compute a kind of mean-of-medians, for a bit more stability than a mean.
            const lbl = (obj.name || '—') + ': ' + key
            let v = got[key]
            v.sort((a,b) => a-b)
            if (v.length > 16) v = v.slice(v.length * .25 | 0, v.length * .75 | 0)
            display(plots, lbl, round(v.reduce((a,b) => a+b) / v.length))
          }
      })
      this.disabled = false
      function round(x) { return Math.round(x*100) / 100 }
    }
  </script>
</body>
</html>