function init$d(e){class IFFT{constructor(e){this.N=e,this.reverseTable=new Uint32Array(e),this.calculateReverseTable()}calculateReverseTable(){let e=1,t=this.N>>1;for(;e<this.N;){for(let n=0;n<e;++n)this.reverseTable[n+e]=this.reverseTable[n]+t;e<<=1,t>>=1}}do(t,n){e._assert(t.length===this.N),e._assert(t.length===n.length);const s=e._allocF32(t.length),a=e._allocF32(n.length);for(let e=0;e<this.N;++e)s[e]=t[this.reverseTable[e]],a[e]=n[this.reverseTable[e]];let r=1;for(;r<this.N;){const e=Math.cos(-Math.PI/r),t=Math.sin(-Math.PI/r);let n=1,o=0;for(let i=0;i<r;++i){const l=n,c=o;for(let e=i;e+r<this.N;e+=r<<1){const t=e+r,n=l*s[t]-c*a[t],o=l*a[t]+c*s[t];s[t]=s[e]-n,s[e]+=n,a[t]=a[e]-o,a[e]+=o}n=l*e-c*t,o=l*t+c*e}r<<=1}for(let e=0;e<this.N;++e)s[e]/=this.N;return e._deallocF32(a),s}}function t(n,s=0){t.n!==n.length&&(t.o=new IFFT(n.length),t.n=n.length);const a=e._allocF32(n.length).fill(s);try{return t.o.do(n,a)}finally{e._deallocF32(a)}}return class Sound extends e.Handler{static docs(){return"Exposes data as sound, for humans to listen.\n\nIn Chrome, users might have to first click on the page for sound to play.\n\n(This handler normalizes output frequencies to be zero-mean, so provide a diverse picture rather than a single number with a varying magnitude.)\n\n- Extra options, for `constructor` and `resume`:\n    - `volume = .3`: amplitude of sound output.\n    - `minFrequency = 1000`, `maxFrequency = 13000`: how well you can hear. [From 20 or 50, to 16000 or 20000 is reasonable.](https://en.wikipedia.org/wiki/Hearing_range) The wider the range, the higher the bandwidth.\n    - `nameImportance = .5`: multiplier of cell names. Non-1 to make it easier on your ears, and emphasize data.\n    - `debug = false`: if set, visualizes frequency data in a `<canvas>`. (Usable for quickly testing `.Sensor.Video`.)\n"}static options(){return{volume:{"100%":()=>1,"30%":()=>.3,"10%":()=>.1,"3%":()=>.03,"1%":()=>.01},minFrequency:{"1 kHz":()=>1e3,"0 Hz":()=>0,"5 kHz":()=>5e3},maxFrequency:{"13 kHz":()=>13e3,"16 kHz":()=>16e3,"20 kHz":()=>2e4,"∞":()=>999999999},nameImportance:{"50%":()=>.5,"100%":()=>1,"0%":()=>0},debug:{No:!1,Yes:!0}}}resume(e){return e&&(e.onValues=Sound.onValues,e.noFeedback=!0,this.volume="number"==typeof e.volume&&e.volume>=0&&e.volume<=1?e.volume:.3,this.minFrequency=void 0!==e.minFrequency?e.minFrequency:1e3,this.maxFrequency=e.maxFrequency||13e3,this.nameImportance=void 0!==e.nameImportance?e.nameImportance:.5,this.debug=e.debug),super.resume(e)}onlyIfNoExtension(){return!0}static bench(){let t=1;return new Array(3).fill().map(((e,t)=>1+10*t)).map((function(n){return function(){function s(e){t=Math.random()}addEventListener("pointerdown",s);const a=new Array(n).fill().map((()=>new e.Sensor({name:["some","kinda","name"],values:64,onValues(e){for(let n=0;n<e.length;++n)e[n]=(2*Math.random()-1)*t;this.send(e)}}))),r=new Sound({volume:.01});return function(){a.forEach((e=>e.pause())),r.pause(),removeEventListener("pointerdown",s)}}}))}static onValues(n,{data:s,cellShape:a}){if(!s||!s.length)return n();if(Sound.ctx||(Sound.ctx=new AudioContext,Sound.next=Sound.ctx.currentTime,Sound.overshoot=0,Sound.dst=Sound.ctx.createAnalyser(),Sound.dst.fftSize=2048,Sound.dst.smoothingTimeConstant=0,Sound.dst.connect(Sound.ctx.destination)),this.debug&&!Sound.debug){const e=Sound.debug=document.createElement("canvas");function t(){requestAnimationFrame(t);const n=new Float32Array(Sound.dst.frequencyBinCount);Sound.dst.getFloatFrequencyData(n),e.ctx.fillStyle="rgb(200, 200, 200)",e.ctx.fillRect(0,0,e.width,e.height),e.ctx.lineWidth=2,e.ctx.strokeStyle="rgb(0, 0, 0)",e.ctx.beginPath();const s=e.width/n.length;let a=1e-6;for(let e=0;e<n.length;++e)a=Math.max(a,Math.abs(n[e]));for(let t=0,a=0;t<n.length;++t,a+=s){const s=(n[t]+105)/65,r=e.height-s*e.height;t?e.ctx.lineTo(a,r):e.ctx.moveTo(a,r)}e.ctx.stroke()}e.width=1024,e.ctx=e.getContext("2d"),document.body.append(e),t()}const r=a.reduce(((e,t)=>e+t)),o=Sound.ctx.sampleRate,i=Math.min(this.maxFrequency,o),l=Math.ceil(s.length*o/i),c=Sound.ctx.outputLatency||Sound.ctx.baseLatency,u=Sound.ctx.createBuffer(1,l,o),h=Math.max(Sound.next,Sound.ctx.currentTime+c),d=this.minFrequency/o*l;(function(n,s,o,i,l,c){const u=r-a[a.length-1];s.fill(0);const h=Math.floor(i);if(1!==l){const t=e._allocF32(n.length/r|0);for(let e=0;e<n.length;++e){const s=e/r|0;e%r<u||(t[s]+=n[e])}for(let e=0;e<t.length;++e)t[e]/=r-u;for(let e=0;e<n.length;++e){const a=e/r|0,o=e%r<u?l*n[e]+(1-l)*t[a]:n[e];s[h+e]=o}e._deallocF32(t)}else if(h+n.length<=n.length)s.set(n,h);else for(let e=0;e<n.length&&h+e<s.length;++e)s[h+e]=n[e];let d=(s.length>2?s.reduce(((e,t)=>e+t)):1)/s.length;this.mean?this.mean=.9*this.mean+.1*d:this.mean=d;for(let e=0;e<s.length;++e)s[e]-=this.mean;const f=t(s,c);f[0]=0,s.set(f);for(let e=0;e<s.length;++e)s[e]*=o;e._deallocF32(f)}).call(this,s,u.getChannelData(0),this.volume,d,this.nameImportance,0);const f=Sound.ctx.createBufferSource();f.buffer=u,e.meta.metric("gap in sound, bool",h!==Sound.next?1:0),e.meta.metric("latency, s",Sound.next-Sound.ctx.currentTime),f.connect(Sound.dst),f.start(h),Sound.next=h+l/o;const m=Math.max(1e3*(Sound.next-.03-Sound.ctx.currentTime-(h===Sound.next?0:c))-5-Sound.overshoot,0);if(m>Sound.overshoot){const e=performance.now()+m;setTimeout((()=>{Sound.overshoot=.75*Sound.overshoot+.25*Math.max(performance.now()-e,0),n(m)}),m)}else n()}}}function init$c(e){const t=Object.assign;return t(class Video extends e.Sensor{static docs(){return"A sequence of images.\n\nImages are divided into [small patches, which has mostly been shown to work well in ML.](https://en.wikipedia.org/wiki/Vision_transformer)\n\nThis sensor's output is composed of 1 or more tiles, which are square images.    \nIt can target 0 or 1+ points, each shown in 1 or more tiles, and can include multiple zoom levels.\n\nExtra options:\n- `name`: heeded, augmented.\n- `tileDimension = 8`: each tile edge's length.\n- `source = Video.stitchTab()`: where to fetch image data from. `MediaStream` or `<canvas>` or `<video>` or `<img>` or a function to one of these.\n    - Feedback is currently not implemented.\n- `monochrome = true`: make this `true` to only report [luminance](https://en.wikipedia.org/wiki/Relative_luminance) and use 3× less data.\n- `targets = Pointer.tab()`: what to focus rectangles' centers on. This is a live array of `{x,y}` objects with 0…1 viewport coordinates, or a function to that, called every frame.\n    - If empty, the whole `source` will be resized to fit, and zooming will zoom in on the center instead of zooming out; if not, the viewed rect will be centered on the target.\n- `tiling = 2`: how many vertical/horizontal repetitions there are per target or screen.\n- `zoomSteps = 3`: how many extra zoomed views to generate per target or screen.\n- `zoomStepStart = 0`: the least-zoomed zoom level.\n- `zoomStep = 2`: the multiplier/divider of in-source tile dimension, per zoom step.\n"}static options(){return{tileDimension:{"8×8":()=>8,"16×16":()=>16,"32×32":()=>32,"4×4":()=>4},source:{"Stitch the tab's canvas/video/img elements":()=>e.Sensor.Video.stitchTab(),"Tab/window/screen":()=>e.Sensor.Video.requestDisplay(),Camera:()=>e.Sensor.Video.requestCamera()},monochrome:{Yes:!0,No:!1},targets:{"Tab's pointers":()=>e.Sensor.Pointer.tab(),"Virtual pointer 1":()=>e.Sensor.Pointer.pointer1(),"Virtual pointer 2":()=>e.Sensor.Pointer.pointer2(),None:()=>[]},tiling:{"2×2":()=>2,"3×3":()=>3,"4×4":()=>4,"8×8":()=>8,"1×1":()=>1},zoomSteps:{"3 ":()=>3,"2 ":()=>2,"1 ":()=>1,"0 ":()=>0},zoomStepStart:{"0 ":()=>0,"1 ":()=>1,"2 ":()=>2,"3 ":()=>3},zoomStep:{"2×":()=>2,"3×":()=>3,"4×":()=>4,"8×":()=>8,"16×":()=>16}}}pause(){return this._nextTarget&&this._nextTarget.pause(),super.pause()}resume(t){if(t){const n=t.tileDimension||8,s=t.source||Video.stitchTab(),a=t.targets||e.Sensor.Pointer.tab(),r=void 0!==t.zoomSteps?t.zoomSteps:3,o=t.zoomStepStart||0,i=void 0!==t.zoomStep?t.zoomStep:2,l=void 0!==t.tiling?t.tiling:2;e._assertCounts("Non-integer tile side",n),e._assert(n>0),e._assert("function"==typeof s||s instanceof Promise||s instanceof MediaStream||s instanceof Element&&("CANVAS"===s.tagName||"VIDEO"===s.tagName||"IMG"===s.tagName),"Bad source"),e._assert("function"==typeof a||Array.isArray(a),"Bad targets"),e._assertCounts("Non-integer zoom step count",r,o),e._assert(o<r,"Too zoomed-out at the start"),e._assertCounts("Non-integer zoom step",i),e._assert(i>=2,"Pointless zoom step"),e._assertCounts("Non-integer tiling",l),e._assert(l>0),this.tileDimension=n,this.source=s,this._tiles=l*l*(r-o+1),this.monochrome=void 0===t.monochrome||!!t.monochrome,this.targets=a,this._targetIndex=t._targetIndex||0;const c=Object.assign,u=Object.create;this._opts=c(c(u(null),t),{source:s,targets:a,_targetIndex:this._targetIndex+1}),this._nextTarget||(this._nextTarget=null),this.zoomSteps=r,this.zoomStepStart=o,this.zoomStep=i,this.tiling=l,this._width=1,this._height=1,t.emptyValues=0,t.onValues=this.onValues,t.noFeedback=!0,t.values=this._tiles*n*n*(this.monochrome?1:3);const h=(e,t,n)=>{const s=Math.ceil(n/(t-e)),a=Math.ceil(this.values/s),r=e/a/(this.monochrome?1:3)|0,o=this.tileDimension,i=this._targets()[this._targetIndex],l=i?i.x:0,c=i?i.y:0,u=this.zoomSteps,h=this.zoomStep,d=this.tiling,f=d*d,m=h**((r/f|0)%(u-this.zoomStepStart+1)+this.zoomStepStart),p=Video._tileMove(!1,r%f,d),g=Video._tileMove(!0,r%f,d),y=this.monochrome?-1:(e/a|0)%3-1;return{x:b(l+p*m*o/this._width),y:b(c+g*m*o/this._height),zoom:m,color:y};function b(e){return Math.max(0,Math.min(e,1))}},d=Array.isArray(t.name)?t.name:"string"==typeof t.name?[t.name]:[String(n)+this.monochrome];t.name=["video",...d,(...e)=>2*h(...e).x-1,(...e)=>2*h(...e).y-1,r?(...e)=>Math.min(Math.log2(h(...e).zoom)/5-1,1):-1]}return super.resume(t)}static bench(){return new Array(3).fill().map(((e,t)=>2**(t+9))).map((function(t){return function(){const n=document.createElement("canvas"),s=n.getContext("2d");n.width=n.height=t;let a=!1;!function e(){a||(requestAnimationFrame(e),s.fillStyle=["red","green","blue"][3*Math.random()|0],s.fillRect(Math.random()*t|0,Math.random()*t|0,51,51))}();const r=new Video({source:n.captureStream(),targets:[{x:.5,y:.5}],monochrome:!1,tileDimension:8,zoomSteps:3,zoomStep:2,tiling:2}),o=new e.Handler({dataSize:64,noFeedback:!0,onValues(e,{data:t,error:n,cellShape:s}){e()}});return setTimeout((()=>e.meta.metric("resolution",t)),500),function(){a=!0,r.pause(),o.pause()}}}))}onValues(e){const t=this.cellShape();if(!t)return;const n=t[t.length-1],s=this._targets(),a=s[this._targetIndex],r=s[this._targetIndex+1];r&&!this._nextTarget&&(this._opts._targetIndex=this._targetIndex+1,this._nextTarget=new Video(this._opts)),r&&this._nextTarget&&this._nextTarget.paused&&(this._opts._targetIndex=this._targetIndex+1,this._nextTarget.resume(this._opts)),!r&&this._nextTarget&&(this._nextTarget.pause(),this._nextTarget=null),this._dataContext2d(e,n,a)&&this.sendCallback(this.onFeedback,e)}onFeedback(e){e&&this.noFeedback}_targets(){const t="function"==typeof this.targets?this.targets():this.targets;return e._assert(Array.isArray(t),"Bad targets"),t}static _tileMove(e=!1,t,n){if(1===n)return 0;return e?(t/n|0)+.5-.5*n:t%n+.5-.5*n}static _sourceToDrawable(e){if("function"==typeof e&&(e=e()),e instanceof Promise){if(!("result"in e))return"error"in e?e:null;e=e.result}if(!(e instanceof MediaStream))return e;const t=Video._streamToVideo||(Video._streamToVideo=new WeakMap);if(!t.has(e)){const n=document.createElement("video");"srcObject"in n?n.srcObject=e:n.src=URL.createObjectURL(e),n.volume=0,n.play(),t.set(e,n)}return t.get(e)}_dataContext2d(e,t,n){let s=Video._sourceToDrawable(this.source);if(s instanceof Promise)return console.error(s.error),this.pause(),!1;if(!s)return null;let a=this._width=s.videoWidth||s.width||1,r=this._height=s.videoHeight||s.height||1;if(!this._canvas){function e(e){return new Array(2).fill().map(e)}this._canvas=e((()=>document.createElement("canvas"))),this._ctx2d=e(((e,t)=>this._canvas[t].getContext("2d",{alpha:!1}))),this._i=0,this._slow=0}let o=++this._i,i=this._slow>.5?(o+1)%2:o%2,l=o%2;const c=this._canvas[l],u=this._ctx2d[l],h=this._ctx2d[i],d=this.tileDimension,f=this._tiles,m=this.zoomSteps,p=this.zoomStep,g=this.tiling;c.width=g*d,c.height=g*(m+1)*d;for(let e=this.zoomStepStart,t=0;e<=m;++e,++t){const o=p**e;if(n){const e=n.x*a+o*d*.5*(1-g)|0,i=n.y*r+o*d*.5*(1-g)|0;u.drawImage(s,e,i,o*d,o*d,0,g*t*d,g*d,g*d)}else{const e=.5*a*(1-1/o)|0,n=.5*r*(1-1/o)|0;u.drawImage(s,e,n,a/o,r/o,0,g*t*d,g*d,g*d)}}const y=this.monochrome,b=performance.now(),k=h.getImageData(0,0,g*d,g*(m+1)*d).data,S=performance.now()-b;this._slow=.9*this._slow+.1*(S>10);for(let n=0;n<f;++n){const s=d*(g-1),a=(n/g|0)*g*d*d+n%g*d;for(let r=0;r<t;++r){const o=r/d|0,i=k[4*(a+o*s+r)+0]/255,l=k[4*(a+o*s+r)+1]/255,c=k[4*(a+o*s+r)+2]/255;y?e[n*t+r]=2*(.2126*i+.7152*l+.0722*c)-1:(e[(3*n+0)*t+r]=2*i-1,e[(3*n+1)*t+r]=2*l-1,e[(3*n+2)*t+r]=2*c-1)}}return!0}},{stitchTab:t((function(){const t=e.Sensor.Video._tab||(e.Sensor.Video._tab={});t.canvas||(t.canvas=document.createElement("canvas"),t.ctx=t.canvas.getContext("2d",{alpha:!1}),t.lastStitch=performance.now());const n=t.canvas,s=t.ctx;let a,r;return function(){return performance.now()-t.lastStitch<15||(t.lastStitch=performance.now(),a=innerWidth,r=innerHeight,n.width=a,n.height=r,s.clearRect(0,0,a,r),Array.from(document.getElementsByTagName("canvas")).forEach(o),Array.from(document.getElementsByTagName("video")).forEach(o),Array.from(document.getElementsByTagName("img")).forEach(o)),n};function o(e){const t=e.getBoundingClientRect();t.x+t.width<0||t.y+t.height<0||t.x>a||t.y>r||s.drawImage(e,0|t.x,0|t.y,t.width,t.height)}}),{docs:"Views on-page `<canvas>`/`<video>`/`<img>` elements. The rest of the page is black.\n\nThe result is usable as the `source` option for `Video`."}),requestDisplay:t((function(e=1024){const t={audio:!0,video:!e||{width:{max:e}}},n=navigator.mediaDevices.getDisplayMedia(t).then((e=>n.result=e)).catch((e=>n.error=e));return function(){return n}}),{docs:"[Requests a screen/window/tab stream.](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getDisplayMedia)\n\nFor performance, max width is 1024 by default; pass in 0 or something else if needed.\n\nThe result is usable as the `source` option for `Video`."}),requestCamera:t((function(e=1024){const t={audio:!0,video:!e||{width:{max:e}}},n=navigator.mediaDevices.getUserMedia(t).then((e=>n.result=e)).catch((e=>n.error=e));return function(){return n}}),{docs:"[Requests a camera stream.](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)\n\nFor performance, max width is 1024 by default; pass in 0 or something else if needed.\n\nThe result is usable as the `source` option for `Video`."})})}function init$b(e){const t=Object.assign;return t(class Reward extends e.Transform{static docs(){return"Sets reward for all cells unless already set.\n\nOptions:\n- `reward = Reward.keybindings('Ctrl+ArrowUp', 'Ctrl+ArrowDown')`: the function that, given nothing, will return the reward each frame, -1…1.\n"}static options(){return{reward:{"+1 Ctrl+Up / -1 Ctrl+Down":()=>Reward.keybindings("Ctrl+ArrowUp","Ctrl+ArrowDown"),"+1 Shift+Up / -1 Shift+Down":()=>Reward.keybindings("Shift+ArrowUp","Shift+ArrowDown"),"+1 F8 / -1 F9":()=>Reward.keybindings("F8","F9")}}}resume(t){if(t){const n=t.reward||Reward.keybindings();e._assert("function"==typeof n),this.reward=n,t.onValues=Reward.onValues}return super.resume(t)}static onValues(t,{data:n,error:s,noData:a,noFeedback:r,cellShape:o,partSize:i}){try{const s=this.reward();if(e._assert("number"==typeof s&&s>=-1&&s<=1),0===s)return;const a=o.reduce(((e,t)=>e+t));for(let e=0;e<n.length;e+=a)0===n[e]&&(n[e]=s)}finally{t()}}},{keybindings:t((function(t="Ctrl+ArrowUp",n="Ctrl+ArrowDown"){e._assert(t!==n),t=c(t),n=c(n);const s={passive:!0};let a=0,r=!1,o=!1,i=!1,l=null;return d(),function(){return d(),o&&!i?1:!o&&i?-1:0};function c(t){e._assert("string"==typeof t);const n=[""],s=t.split("+");for(let t of s.slice(0,-1))["Alt","Ctrl","Meta","Shift"].includes(t)?n.push(t.toLowerCase()+"Key"):t&&e._assert(!1,"Bad key: "+t);return n[0]=s[s.length-1]||"+",n}function u(e){if(e.key===t[0]){let n=!0;for(let s=1;s<t.length;++s)e[t[s]]||(n=!1);n&&(o=!0,e.preventDefault())}if(e.key===n[0]){let t=!0;for(let s=1;s<n.length;++s)e[n[s]]||(t=!1);t&&(i=!0,e.preventDefault())}}function h(e){e.key===t[0]&&(o=!1),e.key===n[0]&&(i=!1)}function d(){a=performance.now(),r||(r=!0,addEventListener("keydown",u),addEventListener("keyup",h,s),l=setInterval((()=>{performance.now()-a>15e3&&function(){if(!r)return;r=!1;removeEventListener("keydown",u),removeEventListener("keyup",h,s),clearInterval(l),l=null}()}),1e4))}}),{docs:"The human has access to 2 buttons: +1 reward and -1 reward.\n\nBy default, 'Ctrl+ArrowUp' is +1, 'Ctrl+ArrowDown' is -1. [Can use other keybindings.](https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key/Key_Values)\n"})})}function init$a(e){const t=Object.assign,n="_uiActive",s=new WeakMap,a=t((function t(){const n=function(){const e=localStorage.snOptions;return e&&JSON.parse(e)}()||[{}],s=r([{tag:"textarea",readonly:!0,style:"width:100%; resize:vertical"}]),a=r([{onchange:o,onclick:o},t.collapsed(" As JS",s,!0),t.channel(e,n[0])]);return s.value=t.toJS(n),s.rows=s.value.split("\n").length,a;function o(e){var a;("click"!==e.type||e.target&&"BUTTON"===e.target.tagName)&&(s.value=t.toJS(n),s.rows=s.value.split("\n").length,a=n,localStorage.snOptions=JSON.stringify(a))}}),{docs:"Creates UI for convenient configuration of sensors. Append it to `document.body` or something.\n\nCSS not included. Markdown parsing not included.\n\n(It doesn't affect code size that much, was quick to develop, and made apparent a few bugs, so why not?)",groupOf(t){const n=Object.getPrototypeOf(t);return n===e.Sensor?"sensor":n===e.Transform?"transform":n===e.Handler?"handler":"object"},nameOf:t=>t.name||(t===e?"Sensor network":`(Unnamed ${a.groupOf(t)})`),options(o,i={},l=null){if("function"!=typeof o.options||o===a)return;const c="object"!==a.groupOf(o),u=Object.create(l),h=o.options(u);e._assert(h&&"object"==typeof h,"Invalid options format"),i=function(t,s={}){for(let a of Object.keys(t))a===n||void 0!==s[a]||t[a]instanceof Node||(e._assert(Object.keys(t[a]).length,"Can't just be an empty object"),s[a]=Object.keys(t[a])[0],g(t[a])&&(s[a]=t[a][s[a]]));return s}(h,i),y(h,i);const d=c?new o:null,f=[];!function(e,t,s,a){const r=[{tag:"table"}];for(let e of Object.keys(s)){if(e===n)continue;let l;if(s[e]instanceof Node)l=s[e];else if(g(s[e]))l=[{tag:"input",type:"checkbox",onchange:o},a[e]?{checked:!0}:null];else{const t=""+Math.random();l=[{tag:"select",id:t,onchange:o}];for(let t of Object.keys(s[e]))l.push([{tag:"option",value:t},a[e]===t?{selected:"selected"}:null,[{tag:"code"},t]])}function o(){a[e]="boolean"==typeof this.checked?this.checked:this.value,y(s,a),t&&!1===t.paused&&(t.pause(!0),t.resume(u))}r.push([{tag:"tr"},[{tag:"td",style:"text-align:right"},(i=e,i[0].toUpperCase()+i.slice(1).replace(/[A-Z]/g,(e=>" "+e.toLowerCase()))+":")],[{tag:"td"},l]])}var i;e.push(r)}(f,d,h,i);const m=r(f),p=d&&setInterval((()=>{m.isConnected||(d.pause(),clearInterval(p))}),1e4);return t(m,{selected:i,opts:u,pause(){d&&d.pause()},resume(){d&&d.resume(y(h,i))}});function g(e){return Object.values(e).every((e=>"boolean"==typeof e))}function y(e,t){const a={};for(let e of Object.keys(u))delete u[e];for(let s of Object.keys(e)){if(s===n||e[s]instanceof Node)continue;const r="boolean"==typeof t[s]?t[s]:e[s][t[s]];u[s]="function"==typeof r?r():r;const o=g(e[s])?Object.values(e[s])[0]:Object.keys(e[s])[0];t[s]!==o&&(a[s]=""+r)}return s.set(t,a),u}},collapsed:(e,t,n=!0)=>r([{tag:"div",class:n?"hiding isHiding":"hiding"},[{tag:"div",class:"hidingSurface"}],[{class:"hidingMarker"},"▶"],e,[{tag:"div",class:"hidable"},n&&{style:"height:0px"},t]]),docsTransformer:e=>e.split("\n")[0],oneOrMore(n,s=[]){let a=0;const o=s[a]||(s[a]={});++a;const i=n(r([{tag:"button",onclick:u},"+"]),o),l=[],c=r(i);for(;a<s.length;)u();return t(c,{pause(){i.pause&&i.pause(),l.forEach((e=>e.pause&&e.pause())),l.length=0},resume(){i.resume&&i.resume()}});function u(){const t=s[a]||(s[a]={});++a;const o=n(r([{tag:"button",onclick(){e._assert(s.indexOf(t)>=0),s.splice(s.indexOf(t),1),--a,o.remove(),l.splice(l.lastIndexOf(o),1),o.pause()}},"-"]),t);l.push(o),c.append(o)}},describe(e,s=[],o=null,i=null){let l="string"==typeof e.docs?e.docs:"function"==typeof e.docs?e.docs():null;l=l&&l.split("\n\n"),l=l&&(l.length>1?a.collapsed([{style:"display:inline-block"},a.docsTransformer(l[0])],[a.docsTransformer(l.slice(1).join("\n\n"))]):r(l));const c="object"!==a.groupOf(e);let u=" "+a.nameOf(e);return" Sensor"===u&&(u=" Sensor →")," Transform"===u&&(u=" → Transform →")," Handler"===u&&(u=" → Handler"),c?a.oneOrMore(h,s):h(null,s[0]||(s[0]={}));function h(s,h){const d=a.options(e,h,o);if(!d){const e=r([s||null,u]);return a.collapsed(e,[l&&l.cloneNode(!0),i],!0)}const f=""+Math.random(),m=c&&r([{id:f,tag:"input",type:"checkbox",class:"checkboxRunning",title:"Currently active",onchange(e){d&&(h[n]=this.checked,this.checked?d.resume():d.pause())}}]);return m&&h[n]&&setTimeout((()=>m.click()),0),h[n]||(h[n]=!1),t(a.collapsed([m?{style:"position:relative; z-index:2"}:null,s||null,m||null,m?[{tag:"label",htmlFor:f},u]:u],[l&&l.cloneNode(!0),d,i],!0),{opts:d&&d.opts,pause(){d.pause&&d.pause()},resume(){d.resume&&d.resume()}})}},channel:(n=e,s={})=>function n(s,o={},i=null){if(!s||"object"!=typeof s&&"function"!=typeof s)return;const l=r([]),c=a.describe(s,o._||(o._=[]),i,l);1!==o._.length||Object.keys(o._[0]).length||delete o._;const u=Object.keys(s).map((e=>{const t=n(s[e],o[e]||(o[e]={}),c.opts||i);return Object.keys(o[e]).length||delete o[e],t})).filter((e=>e));if(s===e)return r(u);if("function"==typeof s.options&&s!==a||u.length){return l.replaceWith(r(u)),t(h.call(r([{onchange:h},c])),{pause(){c.pause&&c.pause(),u.forEach((e=>e.pause&&e.pause()))},resume(){c.resume&&c.resume(),u.forEach((e=>e.resume&&e.resume()))}});function h(e){const t=this.querySelectorAll(".checkboxRunning:checked");if(this.classList.toggle("anyRunningInside",!!t.length),e&&e.target&&!u.some((t=>t.contains(e.target))))for(let e of Array.from(t))e.click(),e.click();return this}}}(n,s),toJS(e=[]){let a=["import sn from 'sensor-network'\n"];return e.forEach((e=>o(e,"sn",{}))),a.join("\n");function r(e){return s.get(e)||e}function o(e,s,i){if(Array.isArray(e._)&&e._.forEach((e=>{if(!e[n])return;const o=t({},i);t(o,r(e));a.push(`new ${s}({${Object.keys(o).map((e=>{let t=o[e];return"boolean"==typeof t||"false"===t||"true"===t?`${e}:${t}`:("()=>"===t.slice(0,4)&&(t="() "+t.slice(2)),"() =>"===t.slice(0,5)&&(t=t.slice(5).trim(),"{"!==t[0])?`${e}:${t}`:`${e}:(${t})()`)}))}})`)})),!e||"object"!=typeof e)return;const l=t({},i);Array.isArray(e._)&&e._[0]&&t(l,r(e._[0]));for(let t of Object.keys(e))"_"!==t&&o(e[t],s+"."+t,l)}}});return a;function r(e){if(e instanceof Promise){const t=document.createElement("div");return e.then((e=>t.replaceWith(r(e))),(e=>t.replaceWith(e instanceof Error?"<Error: "+e.message+">":"<Error>"))),t.classList.add("promise"),t}if(Array.isArray(e)){let t="span";for(let n=0;n<e.length;++n)!e[n]||e[n]instanceof Node||"string"!=typeof e[n].tag||(t=e[n].tag);const n=document.createElement(t);for(let t=0;t<e.length;++t)if(!e[t]||Array.isArray(e[t])||"object"!=typeof e[t]||e[t]instanceof Promise||e[t]instanceof Node)null!=e[t]&&n.append(r(e[t]));else for(let s of Object.keys(e[t])){const a=n[s]=e[t][s];"tag"===s||"string"!=typeof a&&"number"!=typeof a&&"boolean"!=typeof a||n.setAttribute(s,a)}return n}return e instanceof Node?e:document.createTextNode(""+e)}}function init$9(e){const t=Object.assign;let n=null;const s=Object.create(null),a=Object.create(null);function r(e){if(s[e])return s[e];const t=self.YaMD5.hashStr(e,!0),n=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),r=String.fromCharCode(...n);s[e]=r;let i=a,l=r;for(let t=0;t<=8;++t)i[l]=e,i=i._||(i._=Object.create(null)),l=o(l);return r}function o(e){return e.split("").map((e=>String.fromCharCode(e.charCodeAt()/2|0))).join("")}function i(e){for(let t=0;t<e.length;++t)if(0!==e.charCodeAt(t))return!1;return!0}return t(class Text extends e.Sensor{static docs(){return"Observe text, or suggest completions.\n\nText: abstract, compressed, easy for humans to create. You are reading it.    \nSplit into tokens, which are presumably interconnected, and defined by each other.\n\nOptions:\n- `name`: heeded, augmented.\n- `tokens = 64`: max token count, in characters by default.\n- `tokenSize = 64`: how many numbers each token takes up. Ideally, should match the handler's `dataSize`.\n- `text = Text.readSelection()`: the actual text observation.\n    - A string, or `<input>` or `<textarea>`, or a function that returns a string.\n    - Optional `.feedback(string)`.\n- `textToTokens = Text.textToTokens`: splits text into tokens, characters by default.\n    - `function(string, tokens) → [...token]`\n    - `.feedback([...token]) → string`\n- `tokenToData = Text.tokenToDataMD5`: converts a token to actual numbers.\n    - `function(token, data, start, end)`\n    - `.feedback(feedback, start, end) → token`\n"}static options(){return{tokens:{"64×":()=>64,"128×":()=>128,"256×":()=>256,"512×":()=>512,"1024×":()=>1024,"8×":()=>8},tokenSize:{"64 ":()=>64,"16 ":()=>16,"256 ":()=>256},text:{"Read selection":()=>e.Sensor.Text.readSelection(),"Read hovered-over text":()=>e.Sensor.Text.readHover(e.Sensor.Pointer.tab()),"Read text under virtual pointer 1":()=>e.Sensor.Text.readHover(e.Sensor.Pointer.pointer1()[0]),"Read text under virtual pointer 2":()=>e.Sensor.Text.readHover(e.Sensor.Pointer.pointer2()[0]),"Write selection":()=>e.Sensor.Text.writeSelection()}}}resume(t){if(t){const n=t.tokens||64,s=t.tokenSize||64,a=Array.isArray(t.name)?t.name:"string"==typeof t.name?[t.name]:[],r=t.text||Text.readSelection(),o=t.textToTokens||Text.textToTokens,i=t.tokenToData||Text.tokenToDataMD5,c="string"==typeof r||"function"==typeof r||l(r),u=("function"==typeof r.feedback||l(r.feedback))&&"function"==typeof o.feedback&&"function"==typeof i.feedback;e._assertCounts("",n,s),e._assert(c||u),e._assert("function"==typeof o&&"function"==typeof i),t.values=n*s,t.name=["text",...a,(e,t,n)=>2*t/n-1],t.emptyValues=0,t.onValues=this.onValues,t.noFeedback=!u,this.onFeedback="function"==typeof r.feedback?Text.onFeedback:null,this.text=r,this.textToTokens=o,this.tokenToData=i,this.tokens=n,this.tokenSize=s}return super.resume(t)}onValues(t){const n=this.cellShape();if(!n)return;const s=n[n.length-1],a=this.text,r="string"==typeof a?a:l(a)?a.value:"function"==typeof a?a():null;if(null!=r){e._assert("string"==typeof r);const n=this.textToTokens(r,this.tokens);for(let e=0;e<n.length;++e)this.tokenToData(n[e],t,e*s,(e+1)*s);t.fill(0,n.length*s),this.sendCallback(this.onFeedback,t)}else this.sendCallback(this.onFeedback,null)}static onFeedback(e,t){if(!e)return;const n=t.cellShape();if(!n||!t.text||!t.text.feedback)return;const s=n[n.length-1],a=s,r=[],o=Math.min(t.tokens,e.length/s|0);for(let n=0;n<o;++n)r.push(t.tokenToData.feedback(e,n*a,(n+1)*a));const i=t.textToTokens.feedback(r),c=t.text.feedback;l(c)?c.value=i:c(i)}},{readSelection:t((function(e=2048){return function(){const t=document.activeElement;if(l(t)){let n=t.selectionStart,s=t.selectionEnd;return[n,s]=[Math.min(n,s),Math.max(n,s)],t.value.slice(n===s?0:n,s).slice(-e)}const n=getSelection().toString();return n?n.slice(-e):""}}),{docs:"Reads the selection, in document and `<input>`s and `<textarea>`s.\n\nCan pass the maximum returned string length, 2048 by default."}),readHover:t((function(t=e.Sensor.Pointer.tab(),n=2048){return function(){let s=t;if("function"==typeof s&&(s=s()),Array.isArray(s)&&!s.length)return"";Array.isArray(s)&&(s=s[0]),e._assert("number"==typeof s.x&&"number"==typeof s.y);const a=s.x*innerWidth,r=s.y*innerHeight;let o,i;if(document.caretRangeFromPoint){const e=document.caretRangeFromPoint(a,r);o=e.startContainer,i=e.startOffset}else if(document.caretPositionFromPoint){const e=document.caretPositionFromPoint(a,r);o=e.offsetNode,i=e.offset}if(o){let e=o.textContent;if(!(o instanceof Element)){const t=/\s|[!@#$%^&*()\[\]{},\.\-<>/?;:'"\|\&]|$/,n=i+e.slice(i).search(t);e=e.slice(0,Math.max(n,i))}for(;e.length<n&&o;){for(;o&&!o.previousSibling&&o.parentNode;)o=o.parentNode;o=o.previousSibling,o&&(e=o.textContent+e)}return e.slice(-n)}}}),{docs:"Reads the text under the pointer.\n\nCan pass the `{x,y}` object or array/function to that object (`Pointer.tab()` by default), and maximum returned string length, 2048 by default."}),writeSelection:t((function(){return{feedback:function(e){if(!e)return;const t=document.activeElement;if(l(t)){if(t.disabled||t.readOnly)return;let n=t.selectionStart,s=t.selectionEnd;return[n,s]=[Math.min(n,s),Math.max(n,s)],void t.setRangeText(e,n,s,"select")}const n=getSelection();if(n.rangeCount){for(let e=n.getRangeAt(0).commonAncestorContainer;e;e=e.parentNode)e.isContentEditable&&(editablee=!0)}else;}}}),{docs:"Modifies the selection to be the feedback, if possible.\n\nThe new text will still be selected, so it can function as autocomplete or autocorrect."}),textToTokens:t((function(e,t){return e.split("").slice(-t)}),{feedback:e=>e.join("")}),tokenToDataMD5:t((function(t,n,s,a){const o=r(t);if(n){for(let e=0,t=s;e<o.length&&t<a;++e,++t)n[t]=o.charCodeAt(e)/255*2-1;e._dataNamer.fill(n,0,o.length,n.length)}}),{feedback(t,s,l){if(!n){const e=document.documentElement.textContent;for(let t=0;t<e.length;++t)n=r(e[t]).length}e._dataNamer.unfill(t,0,n,t.length);const c=[];for(let e=0,a=s;e<n&&a<l;++e,++a)c.push(String.fromCharCode(Math.round((t[a]+1)/2*255)));return function(e){let t=a,n=e;for(;t;){if(i(n))return"";if(t[n])return t[n];t=t._,n=o(n)}return""}(c.join(""))}})});function l(e){return e&&e instanceof Element&&("INPUT"===e.tagName&&"string"==typeof e.value&&"number"==typeof e.selectionStart||"TEXTAREA"===e.tagName)}}function init$8(e){return class Random extends e.Handler{static docs(){return"Random -1…1 feedback, for debugging."}static options(){return{}}resume(e){return e&&(e.onValues=Random.onValues),super.resume(e)}static onValues(e,t,n){try{if(n)for(let e=0;e<n.length;++e)n[e]=2*Math.random()-1}finally{e()}}}}function init$7(e){return class Scroll extends e.Sensor{static docs(){return"DOM scroll position and its change.\n\nOptions:\n- `name`: heeded, augmented.\n- `mode: 'read'|'write'|'move' = 'read'`: can read, and either set or add-to scroll position.\n- `target:{x,y} = Pointer.tab()`: where to get target-coordinates from (or a function, or an array). Many DOM elements can be scrollable, and `Scroll` tries to return the most relevant ones.\n"}static options(){return{mode:{Read:()=>"read","Read + write":()=>"write","Read + move":()=>"move"},target:{"Tab's pointers":()=>e.Sensor.Pointer.tab(),"Virtual pointer 1":()=>e.Sensor.Pointer.pointer1()[0],"Virtual pointer 2":()=>e.Sensor.Pointer.pointer2()[0]}}}resume(t){if(t){const n=Array.isArray(t.name)?t.name:"string"==typeof t.name?[t.name]:[],s=t.target||e.Sensor.Pointer.tab(),a=t.mode||"read";e._assert(s&&("object"==typeof s||"function"==typeof s)),e._assert(["read","write","move"].includes(a)),t.values=16,t.emptyValues=0,t.name=["scroll",...n],t.onValues=this.onValues,t.noFeedback="read"===a,this.target=s,this.mode=a,this.prevs=new WeakMap,this.els=[]}return super.resume(t)}onValues(e){const n=function(e,n=4){const s=document.scrollingElement||document.documentElement;if(!document.elementsFromPoint||1===n)return[s];let a=e;"function"==typeof a&&(a=a());if(Array.isArray(a)&&!a.length)return"";Array.isArray(a)&&(a=a[0]);const r=document.elementsFromPoint(a.x*innerWidth,a.y*innerHeight);return[s,...r.filter(t).slice(-(n-1))]}(this.target),s=this.prevs;for(let t=0;4*t<e.length;++t)if(n[t]){const a=n[t],r=a.scrollLeft,o=a.scrollWidth-a.clientWidth||1,i=a.scrollTop,l=a.scrollHeight-a.clientHeight||1;s.has(a)||s.set(a,[r,i]);const c=s.get(a);e[4*t+0]=r/o*2-1,e[4*t+1]=i/l*2-1,e[4*t+2]=Math.max(-1,Math.min((r-c[0])/innerWidth,1)),e[4*t+3]=Math.max(-1,Math.min((i-c[1])/innerHeight,1)),c[0]=r,c[1]=i}this.els.push(n),this.sendCallback(this.onFeedback,e)}onFeedback(e){const t=this.els.shift();if(!e||"read"===this.mode)return;const n="move"===this.mode;for(let s=0;4*s<e.length;++s)if(t[s]){const a=t[s];if(n)a.scrollLeft+=e[4*s+2]*innerWidth,a.scrollTop+=e[4*s+3]*innerHeight;else{const t=a.scrollWidth-a.clientWidth,n=a.scrollHeight-a.clientHeight;a.scrollLeft=(e[4*s+0]+1)/2*t,a.scrollTop=(e[4*s+1]+1)/2*n}}}};function t(e){return e!==document.scrollingElement&&(void 0!==e.scrollTopMax?e.scrollTopMax>0:e.scrollHeight>e.clientHeight&&["auto","scroll"].includes(getComputedStyle(e).overflowY))}}function init$6(e){const t=Object.assign;return t(class Audio extends e.Sensor{static docs(){return'Sound that\'s already playing.\n\nIf you need to test what this sensor records, here:\n\n<audio controls crossorigin src="https://file-examples-com.github.io/uploads/2017/11/file_example_MP3_700KB.mp3"></audio>\n\nOptions:\n- `source = Audio.DOM(Audio)`: `<video>` or `<audio>` (with the `crossorigin` attribute if crossorigin), `MediaStream` `function(Audio)(audioContext)`, or the `AudioContext` whose `.destination` is augmented.\n- `fftSize = 2048`: the window size: how many values are exposed per packet (or twice that if `frequency`). [Must be a power-of-2.](https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode/fftSize)\n- `frequency = {minDecibels:-100, maxDecibels:-30}`: `null` to expose `fftSize` time-domain numbers, or an object to expose `fftSize/2` frequency-domain numbers.'}static options(){return{fftSize:{"2048 ":()=>2048,"512 ":()=>512,"16384 ":()=>16384},frequency:{"Frequency-domain":()=>null,"Time-domain":()=>({minDecibels:-100,maxDecibels:-30})}}}resume(t){if(t){const n=Array.isArray(t.name)?t.name:"string"==typeof t.name?[t.name]:[],s=t.fftSize||2048,a=t.frequency||{minDecibels:-100,maxDecibels:-30},r=t.source||Audio.DOM(Audio);e._assert(r instanceof AudioContext||r instanceof MediaStreamTrack||r instanceof Element&&("VIDEO"===r.tagName||"AUDIO"===r.tagName)||"function"==typeof r,"Bad source"),e._assertCounts("",s),e._assert([32,64,128,256,512,1024,2048,4096,8192,16384,32768].includes(s),"Not an acceptable power-of-2"),e._assert(null==a||"number"==typeof a.minDecibels&&"number"==typeof a.maxDecibels),t.name=["text",...n,(e,t,n)=>2*t/n-1],t.values=a?s/2|0:s,t.onValues=this.onValues,t.noFeedback=!0,this.source=r,this.frequency=a,this.ctx&&this.ctx.close(),this.ctx=null;const o=r instanceof AudioContext?r:this.ctx=new AudioContext,i=this.node=o.createAnalyser();i.fftSize=s,i.smoothingTimeConstant=0;const l=o.destination;Object.defineProperty(o,"destination",{configurable:!0,enumerable:!0,value:i,writable:!0}),i.connect(l),r instanceof AudioContext||"function"==typeof r||Audio._connect(t.source,o)}return super.resume(t)}onValues(e){const t=this.node;if(t){if("function"==typeof this.source&&this.ctx&&this.source(this.ctx),this.frequency){t.getFloatFrequencyData(e);const n=this.frequency.minDecibels,s=1/(this.frequency.maxDecibels-n);for(let t=0;t<e.length;++t){const a=(e[t]-n)*s;e[t]=Math.max(-1,Math.min(2*a-1,1))}}else t.getFloatTimeDomainData(e);this.sendCallback(null,e)}}static _connect(t,n){const s=n.destination,a=t instanceof Element?n.createMediaElementSource(t):t instanceof MediaStream?n.createMediaStreamSource(t):e._assert(!1);return a.connect(s),a}},{DOM:t((function(e){let t=null,n=null;return function(s){if(t!==s&&(n=new WeakMap),t=s,!s)return;const a=document.getElementsByTagName("video"),r=document.getElementsByTagName("audio");function o(t){n.has(t)||n.set(t,e._connect(t,s))}Array.prototype.forEach.call(a,o),Array.prototype.forEach.call(r,o)}}),{})})}function init$5(e){const t=Object.assign;return t(class Pointer extends e.Sensor{static docs(){return"Tracks or controls mouse/touch state.\n\nOptions:\n- `name`: heeded, augmented.\n- `noFeedback = true`: `true` to track, `false` to control.\n- `pointers = 1`: how many pointers to track/control. [Also see `navigator.maxTouchPoints`.](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/maxTouchPoints)\n- `pointerSize = 16`: how many numbers each pointer takes up.\n- `targets = Pointer.tab(noFeedback ? 0 : pointers)`: the array of `{x,y, data:[…], set()}` objects to track or control.\n"}static options(){return{noFeedback:{Yes:!0,No:!1},pointers:{"1×":()=>1,"2×":()=>2,"4×":()=>4,"8×":()=>8},pointerSize:{"16 ":()=>16,"64 ":()=>64,"256 ":()=>256},targets:{"Tab's pointers":()=>e.Sensor.Pointer.tab(),"Virtual pointer 1":()=>e.Sensor.Pointer.pointer1(),"Virtual pointer 2":()=>e.Sensor.Pointer.pointer2()}}}resume(t){if(t){const n=t.pointers||1,s=t.pointerSize||16;e._assertCounts("",n,s);const a=t.targets||Pointer.tab(t.noFeedback?0:n),r=Array.isArray(t.name)?t.name:"string"==typeof t.name?[t.name]:[];e._assert("function"==typeof a||Array.isArray(a),"Bad targets"),t.onValues=this.onValues,t.values=n*s,t.name=["pointer",...r],this.pointers=n,this.pointerSize=s,this.targets=a}return super.resume(t)}onValues(t){const n=this._targets();for(let s=0;s<this.pointers;++s){const a=n[s],r=a&&a.data,o=this.pointerSize,i=s*o;if(a){if(t[i+0]=2*a.x-1,t[i+1]=2*a.y-1,r)for(let e=0;e<r.length;++e)t[i+2+e]=2*r[e]-1;e._dataNamer.fill(t,i,2+r.length,o)}else t.fill(0,i,i+o)}this.sendCallback(this.onFeedback,t)}onFeedback(t){if(!t||this.noFeedback)return;const n=this._targets();for(let s=0;s<this.pointers;++s){const a=n[s],r=a&&a.data,o=this.pointerSize,i=s*o;if(a){if(e._dataNamer.unfill(t,i,2+r.length,o),a.x=(t[i+0]+1)/2,a.y=(t[i+1]+1)/2,r)for(let e=0;e<r.length;++e)r[e]=(t[i+2+e]+1)/2;"function"==typeof a.set&&a.set()}}}_targets(){const t="function"==typeof this.targets?this.targets():this.targets;return e._assert(Array.isArray(t),"Bad targets"),t}},{tab:t((function e(t=0){if(!t&&e.result)return e.result;const n=[],s=new Map,a={passive:!0};let r=!1,o=performance.now(),i=null,l=setInterval(c,1e4);if(t)for(let e=0;e<t;++e)g({pointerId:"n"+e});return t?y:e.result=y;function c(){performance.now()-o>15e3&&(function(){if(!r)return;removeEventListener("touchstart",d,a),removeEventListener("touchmove",d,a),removeEventListener("touchcancel",f,a),removeEventListener("touchend",f,a),"undefined"==typeof PointerEvent?(removeEventListener("mousedown",d,a),removeEventListener("mousemove",d,a),removeEventListener("mouseup",f,a)):(removeEventListener("pointerdown",d,a),removeEventListener("pointermove",d,a),removeEventListener("pointerup",f,a));r=!1}(),clearInterval(l),l=null)}function u(e){return Math.max(0,Math.min(e,1))}function h(e,t){t.x=u(e.clientX/innerWidth),t.y=u(e.clientY/innerHeight),t.data[0]=1&e.buttons,t.data[1]=2&e.buttons,t.data[2]=4&e.buttons,t.data[3]=e.isPrimary?1:0,t.data[4]="mouse"===e.pointerType?0:"pen"===e.pointerType?.5:1,t.data[5]=u(e.width/innerWidth),t.data[6]=u(e.height/innerHeight),t.data[7]=u(e.pressure),t.data[8]=u((e.tangentialPressure+1)/2),t.data[9]=u((e.tiltX+90)/180),t.data[10]=u((e.tiltY+90)/180),t.data[11]=u(e.twist/360)}function d(e){if(i=e,"touch"!==e.pointerType)return e.touches?Array.from(e.touches).forEach(d):void h(e,n[g(e)])}function f(e){if(i=e,"touch"===e.pointerType)return;if(!n.length)return;if(e.touches)return n.length=0,s.clear(),Array.from(e.touches).forEach(d);const t=g(e),a=n[t],r=n.length-1;h(e,a),n.length<=1||([n[t],n[r]]=[n[r],n[t]],n.pop(),s.delete(p(e)))}function m(){const e=this,t=e.data,n=e.x*innerWidth,s=e.y*innerHeight,a=t[0]>=.5,r=t[1]>=.5,o=t[2]>=.5,l=t[3]>=.5,c=t[4]<1/3?"mouse":t[4]<2/3?"pen":"touch",u=t[5]*innerWidth,h=t[6]*innerHeight,d=t[7],f=2*t[8]-1,m=180*t[9]-90,p=180*t[10]-90,g=360*t[11],y=document.elementFromPoint(n,s),b=a|r<<1|o<<2,k=e._prevButtons,S={bubbles:!0,screenX:n,screenY:s,clientX:n,clientY:s,ctrlKey:i&&i.ctrlKey,shiftKey:i&&i.shiftKey,altKey:i&&i.altKey,metaKey:i&&i.metaKey,button:k&~b?0:4&b?2:2&b?1:0,buttons:b,relatedTarget:null,pointerId:"string"==typeof e.id?parseFloat(e.id.slice(1)):e.id,width:u,height:h,pressure:d,tangentialPressure:f,tiltX:m,tiltY:p,twist:g,pointerType:c,isPrimary:l},w="mouse"===c||l;_(y,self.PointerEvent,~k&b?"pointerdown":k&~b?"pointerup":"pointermove",S),w&&_(y,MouseEvent,~k&b?"mousedown":k&~b?"mouseup":"mousemove",S);const v=e._target;function _(e,t,n,s){e&&t&&e.dispatchEvent(new t(n,s))}v!==y&&(S.relatedTarget=y,_(v,self.PointerEvent,"pointerout",S),w&&_(v,MouseEvent,"mouseout",S),S.relatedTarget=v,_(y,self.PointerEvent,"pointerover",S),w&&_(y,MouseEvent,"mouseover",S),S.bubbles=!1,S.relatedTarget=y,_(v,self.PointerEvent,"pointerleave",S),w&&_(v,MouseEvent,"mouseleave",S),S.relatedTarget=v,_(y,self.PointerEvent,"pointerenter",S),w&&_(y,MouseEvent,"mouseenter",S),S.bubbles=!0),l&&(a&&!(1&k)&&(e._startTarget=y),!a&&1&k&&y===e._startTarget&&y&&y.click()),e._prevButtons=b,e._target=y}function p(e){return void 0!==e.pointerId?e.pointerId:"identifier"in e?e.identifier:"mouse"}function g(e){const t=p(e);return s.has(t)||s.set(t,n.push({x:.5,y:.5,data:[],set:m,id:t,_prevButtons:0,_startTarget:null,_target:null})-1),s.get(t)}function y(){return o=performance.now(),r||(addEventListener("touchstart",d,a),addEventListener("touchmove",d,a),addEventListener("touchcancel",f,a),addEventListener("touchend",f,a),"undefined"==typeof PointerEvent?(addEventListener("mousedown",d,a),addEventListener("mousemove",d,a),addEventListener("mouseup",f,a)):(addEventListener("pointerdown",d,a),addEventListener("pointermove",d,a),addEventListener("pointerup",f,a)),null==l&&setInterval(c,1e4),r=!0),n}}),{docs:"Returns a closure that returns the dynamic list of mouse/touch positions, `[{x,y,data}]` (all are 0…1; `data` is an optional array of extra data).\n\nThe result is usable as the `targets` option for `Video` and `Pointer`, and as an arg of `Text.readHover`.\n\nCan pass it `n=0`: how many writable pointer objects are guaranteed to be kept alive (but not updated)."}),pointer1:function e(){return e.a||(e.a=[{x:.5,y:.5,data:[]}])},pointer2:function e(){return e.a||(e.a=[{x:.5,y:.5,data:[]}])}})}function init$4(e){return class Keyboard extends e.Sensor{static docs(){return"Tracks or controls keyboard state.\n\nOptions:\n- `name`: heeded, augmented.\n- `noFeedback = true`: `true` to track, `false` to control.\n- `keys = 4`: max simultaneously-pressed [keys](https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key/Key_Values) to report.\n- `keySize = 16`: numbers per key.\n- `tokenToData = sn.Sensor.Text.tokenToDataMD5`: converts a token to actual numbers.\n    - `function(token, data, start, end)`\n    - `.feedback(feedback, start, end) → token`\n"}static options(){return{noFeedback:{Yes:!0,No:!1},keys:{"4×":()=>4,"3×":()=>3,"2×":()=>2,"1×":()=>1,"8×":()=>8,"16×":()=>16},keySize:{"16 ":()=>16,"64 ":()=>64,"256 ":()=>256}}}pause(){return removeEventListener("keydown",this.onkeydown,{capture:!0}),removeEventListener("keyup",this.onkeyup,{capture:!0}),removeEventListener("blur",this.onkeyclear,{capture:!0}),super.pause()}resume(t){if(this.currentKeys||(this.currentKeys=new Set,this.pastKeys=new Set,this.onkeydown=this.onkeydown.bind(this),this.onkeyup=this.onkeyup.bind(this),this.onkeyclear=this.onkeyclear.bind(this),this._pastFBKeys=new Set),t){const n=t.keys||4,s=t.keySize||16,a=e.Sensor.Text.tokenToDataMD5;e._assertCounts("",n,s),e._assert("function"==typeof a),t.noFeedback,Keyboard.prefill(a);const r=Array.isArray(t.name)?t.name:"string"==typeof t.name?[t.name]:[];t.onValues=this.onValues,t.values=n*s,t.name=["keyboard",...r],this.keys=n,this.keySize=s,this.tokenToData=a}try{return super.resume(t)}finally{addEventListener("keydown",this.onkeydown,{capture:!0}),addEventListener("keyup",this.onkeyup,{capture:!0}),addEventListener("blur",this.onkeyclear,{capture:!0})}}onkeydown(e){this.onkeyup(e),this.currentKeys.add(e.key),this.pastKeys.add(e.key)}onkeyup(e){const t=this.currentKeys;t.delete(e.key),t.delete(e.key.toLowerCase()),t.delete(e.key.toUpperCase())}onkeyclear(e){this.currentKeys.clear()}onValues(e){const t=this.keys,n=this.keySize;let s=0;const a=this.currentKeys,r=this.pastKeys,o=this.tokenToData;a.forEach((e=>r.delete(e))),r.forEach((e=>a.add(e))),a.forEach((a=>{s<t&&o(a,e,s*n,(s+1)*n),++s})),e.fill(0,a.size*n),r.forEach((e=>a.delete(e))),r.clear(),this.sendCallback(this.onFeedback,e)}onFeedback(e){if(!e||this.noFeedback)return;const t=this.keys,n=this.keySize,s=this.tokenToData.feedback,a=new Set;for(let r=0;r<t&&r*n<e.length;++r){const t=s(e,r*n,(r+1)*n);t&&a.add(t)}const r={bubbles:!0,key:"",ctrlKey:a.has("Control"),shiftKey:a.has("Shift"),altKey:a.has("Alt"),metaKey:a.has("Meta")},o=this._pastFBKeys,i=document.activeElement||document.body;a.forEach((e=>{o.has(e)||(r.key=e,i.dispatchEvent(new KeyboardEvent("keydown",r)),1===[...e].length?document.execCommand("insertText",!1,e):"Backspace"===e?document.execCommand("delete",!1,null):"Delete"===e&&document.execCommand("forwardDelete",!1,null))})),o.forEach((e=>{a.has(e)||(r.key=e,i.dispatchEvent(new KeyboardEvent("keyup",r)))}))}static prefill(e){e._keyboardFilled||(e._keyboardFilled=!0,[" ",..."! \" # $ % & ' ( ) * + , - . / 0 1 2 3 4 5 6 7 8 9 : ; < = > ? @ A Alt ArrowDown ArrowLeft ArrowRight ArrowUp B Backspace C CapsLock Control D Delete E End Enter Escape F G H Home I J K L M N NumLock O P PageDown PageUp Q R S Shift T Tab U V W X Y Z [ \\ ] ^ _ ` a b c d e f g h i j k l m n o p q r s t u v w x y z { | } ~".split(" ")].forEach((t=>e(t))))}}}function init$3(e){const t=Object.assign,n=[];function s(){return s.did?s.did:s.did=new Promise((e=>{const t=document.createElement("script");t.src="https://unpkg.com/simple-peer@9.11.0/simplepeer.min.js",document.head.append(t);const n=setInterval((()=>{self.SimplePeer&&(clearInterval(n),e(self.SimplePeer))}),50)}))}class InternetSensor extends e.Sensor{static docs(){return"Extends this sensor network over the Internet, to control others.\n\nOptions:\n- `iceServers = []`: the [list](https://gist.github.com/mondain/b0ec1cf5f60ae726202e) of [ICE servers](https://developer.mozilla.org/en-US/docs/Web/API/RTCIceServer/urls) (Interactive Connectivity Establishment).\n- `signaler`: a convenience: on construction, does `sensor.signal(signaler(sensor))` for you. Props of `sn.Handler.Internet` go well here.\n\nMethods:\n- `signal(metaChannel: { send(string), close(), onopen, onmessage, onclose }, maxCells=65536)` for manually establishing a connection: on an incoming connection, someone must notify us of it so that negotiation of a connection can take place, for example, [of a `WebSocket` which can be passed directly](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket).\n\nBrowser compatibility: [Edge 79.](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/createDataChannel)\n\nImports [100 KiB](https://github.com/feross/simple-peer) on use.\n"}static options(){return{iceServers:{None:()=>[],Some:()=>[{urls:"stun: stun.l.google.com:19302"},{urls:"stun: stunserver.org:3478"}]},signaler:{None:()=>{},"Browser tabs":()=>e.Handler.Internet.broadcastChannel,"JS console (F12)":()=>e.Handler.Internet.consoleLog}}}static tests(){return[["Quantization error is correct, f32",h(65536,0),!0],["Quantization error is correct, u8",h(65536,1),!0],["Quantization error is correct, u16",h(65536,2),!0]]}static bench(){return new Array(10).fill().map(((e,t)=>10*(t+1))).map((function(t){const n=[];function s(t){t&&(e.meta.metric("feedback-is-correct fraction",+(this.paused||Math.abs(t[0]- -.97)<.01)),t.fill(.5439828952837),e._deallocF32(t))}return function(){const a={send(e){r.onmessage&&r.onmessage({data:e})}},r={send(e){a.onmessage&&a.onmessage({data:e})}},o=new e.Sensor({channel:"a",name:["remote","data","source"],values:64*t,onValues(e){e.fill(.99),this.sendCallback(s,e)}}),i=new e.Handler.Internet({channel:"a",iceServers:n,signaler:()=>a,untrustedWorkaround:!0}),l=new e.Sensor.Internet({channel:"b",iceServers:n}),c=new e.Handler({channel:"b",dataSize:64,onValues(t,{data:n,noData:s},a){try{n&&n.length&&e._assert(Math.abs(n[64]-.99)<.01,n[64]),n&&n.fill(.489018922485),a&&a.fill(-.97)}finally{t()}}});return l.signal(r),a.onopen&&a.onopen(),r.onopen&&r.onopen(),function(){o.pause(),i.pause(),l.pause(),c.pause()}}}))}resume(e){if(e&&(this.iceServers=e.iceServers||[],e.onValues=this.onValues,e.values=0,e.emptyValues=0,e.name=[],!this._data)){this._data=[],this._feedback=[];const t=e.signaler;"function"==typeof t&&Promise.resolve().then((()=>t(this)))}return super.resume(e)}signal(t,n=65536){if(!t)return;e._assert("function"==typeof t.send);let r,h=[],d=[];t.onopen=e=>{d&&d.forEach((e=>t.send(e))),d=null},t.onmessage=e=>{if("string"!=typeof e.data)return console.warn("dropping",e);const t=JSON.parse(e.data);r?r.signal(t):h.push(t)},s().then((s=>{r=new s({trickle:!t.noTrickle,config:{iceServers:this.iceServers}}),r.on("close",(()=>{r=null,t.close()})),r.on("error",console.error),r.on("signal",(e=>{(e=>{d?d.push(e):t.send(e)})(JSON.stringify(e))}));const f=o(r),p=(t,n,s,a)=>{const r=l(t,n),o=8+4*a.length,i=new Uint8Array(o+r.length),c=new DataView(i.buffer,i.byteOffset,i.byteLength);c.setUint16(0,n),c.setUint32(2,s),c.setUint16(6,a.length);let u=8;for(let e=0;e<a.length;++e)c.setUint32(u,a[e]),u+=4;e._assert(u===o),i.set(r,o),this.paused||f(i)};if(r.on("data",i(((t,s)=>{if(t){if(e._assert(t instanceof Uint8Array),t.length<2)return;const s=new DataView(t.buffer,t.byteOffset,t.byteLength),r=s.getUint32(0),o=s.getUint32(4),i=s.getUint16(8);if(3!==i)return;const l=a(i);let h=10;for(let e=0;e<i;++e)l[e]=s.getUint32(h),h+=4;const d=s.getUint16(h);if(h+=2,0!==d&&1!==d&&2!==d)return;const f=r*l.reduce(((e,t)=>e+t)),g=t.subarray(h,h+=f*(d||4)),y=t.subarray(h,h+=Math.ceil(r/8)),b=t.subarray(h,h+=Math.ceil(r/8));g.length>n*(f/r|0)*(d+1)&&(g=g.subarray(0,n*(f/r|0)*(d+1)));const k=c(g,d),S=u(k.length,d),w=m(y),v=m(b),_=a(9);[_[0],_[1],_[2],_[3],_[4],_[5],_[6],_[7],_[8]]=[o,r,l,d,k,S,w,v,p],this._data.push(_)}else{const e=a(9);e.fill(void 0),e[8]=p,this._data.push(e)}}))),h.length){for(let e of h)r.signal(e);h.length=0}}))}onValues(t){e._deallocF32(t),this.sendRawCallback(this.onFeedback,this._name,this._unname),this._data.length=0}_name({cellShape:t,partSize:n,summary:s},a,r,o,i){for(let n=0;n<this._data.length;++n){let[s,a,l,c,u,h,d,f,m]=this._data[n];void 0===u&&(a=0,u=e._allocF32(0),h=null,d=f=!0);const p=t.reduce(((e,t)=>e+t)),g=a*p,y=l&&l.reduce(((e,t)=>e+t)),b=e._allocF32(g),k=h&&e._allocF32(g);for(let e=0;e<a;++e){const t=e*p,n=e*y;for(let e=0;e<p;++e)b[t+e]=u[n+e]}r.send(this,o,i,b,k||null,d||!0,f||!0),this._feedback.push(this._data[n])}}_unname(t,n,s,a){const r=e._allocF32(n.length);return r.set(n),r}onFeedback(t,n,s){const a=this._feedback.shift();if(!a)return;let[o,i,l,c,u,h,d,f,m]=a;if(void 0===u){const t=e._allocF32(1);t[0]=0,m(t,c,s,n)}else{const a=n.reduce(((e,t)=>e+t)),r=i*a,o=l.reduce(((e,t)=>e+t)),u=e._allocF32(r);if(t)for(let e=0;e<i;++e){const n=e*a,s=e*o;for(let e=0;e<a;++e)u[s+e]=t[n+e]}else u.fill(0);m(u,c,s,n)}t&&e._deallocF32(t),r(a),l&&r(l),d&&r(d),f&&r(f)}}class InternetHandler extends e.Handler{static docs(){return"Makes this environment a remote part of another sensor network, to be controlled.\n\nOptions:\n- `iceServers = []`: the [list](https://gist.github.com/mondain/b0ec1cf5f60ae726202e) of [ICE servers](https://developer.mozilla.org/en-US/docs/Web/API/RTCIceServer/urls) (Interactive Connectivity Establishment).\n- `signaler = sn.Handler.Internet.broadcastChannel`: creates the channel over which negotiation of connections takes place. When called, constructs `{ send(Uint8Array), close(), onopen, onmessage, onclose }`, for example, [`new WebSocket(url)`](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket).\n- `bytesPerValue=0`: 0 to transmit each value as float32, 1 to quantize as uint8, 2 to quantize as uint16. 1 is max-compression min-precision; 0 is the opposite.\n- `autoresume = true`: whether the connection closing will trigger an attempt to re-establish it.\n- `untrustedWorkaround = false`: if set, will request a microphone stream and do nothing with it, so that a WebRTC connection can connect. The need for this was determined via alchemy, so its exact need-to-use is unknown.\n\nImports [100 KiB](https://github.com/feross/simple-peer) on use.\n"}static options(){return{iceServers:{None:()=>[],Some:()=>[{urls:"stun: stun.l.google.com:19302"},{urls:"stun: stunserver.org:3478"}]},signaler:{"Browser tabs":()=>e.Handler.Internet.broadcastChannel,"JS console (F12)":()=>e.Handler.Internet.consoleLog},bytesPerValue:{"float32 (4× size)":()=>0,"uint16 (2× size)":()=>2,"uint8 (1× size)":()=>1},autoresume:{Yes:!0,No:!1},untrustedWorkaround:{No:!1,Yes:!0}}}pause(e){if(!e&&(this.peer&&Promise.resolve(this.peer).then((e=>(e.destroy(),this.peer=null))),this._feedback&&this._feedback.length)){for(let[e,t,n]of this._feedback)e&&e.fill(0),t();this._feedback.length=0,this._dataToSend&&(this._dataToSend.length=0)}return super.pause()}resume(t){if(t){const n=t.bytesPerValue||0;e._assert(0===n||1===n||2===n),t.onValues=this.onValues,this.autoresume=void 0===t.autoresume||t.autoresume,this.iceServers=t.iceServers||[],this.signaler=t.signaler||e.Handler.Internet.broadcastChannel,this.untrustedWorkaround=!!t.untrustedWorkaround,t!==this._opts&&(this._opts=Object.assign(Object.create(null),t)),this._feedback||(this._feedback=[],this.bytesPerValue=n,this._dataSend=null,this._dataToSend=[])}return this.getPeer(),super.resume(t)}getPeer(){if(null==this.metaChannel){const e=this.metaChannel=this.signaler();this._signal=new Promise(((t,n)=>{e.onopen=e=>{this._signal=null,t()},e.onmessage=e=>{if(null==this.peer)return console.warn("dropping signal",e.data);if("string"!=typeof e.data)return console.warn("dropping signal",e.data);const t=JSON.parse(e.data);this.peer instanceof Promise?this.peer.then((e=>e.signal(t))):this.peer.signal(t)},e.onclose=e=>{n(),this._signal=this.metaChannel=null}}))}if(null==this.peer){this._dataSend=null;const t=this.untrustedWorkaround?navigator.mediaDevices.getUserMedia({audio:!0}):Promise.resolve();this.peer=t.then((()=>{throw null})).catch((()=>s().then((t=>{const n=this.peer=new t({trickle:!this.metaChannel.noTrickle,initiator:!0,config:{iceServers:this.iceServers},channelConfig:{ordered:!1,maxRetransmits:0}});function s(e){if(!this.metaChannel)return console.warn("dropping signal",e);this._signal?this._signal.then((()=>this.metaChannel.send(e))):this.metaChannel.send(e)}return n.on("close",(()=>{this.pause(),this.autoresume?setTimeout((()=>this.resume(this._opts)),1e3):console.log("sn.Handler.Internet: close")})),n.on("error",console.error),n.on("signal",(e=>{s.call(this,JSON.stringify(e))})),n.on("connect",(()=>{const t=o(n);if(this._dataSend=({data:n,noData:s,noFeedback:a,cellShape:r,partSize:o},i)=>{const c=n.length/r.reduce(((e,t)=>e+t))|0,u=10+4*r.length+2+(i||4)*n.length+2*Math.ceil(c/8),h=new Uint8Array(u),d=new DataView(h.buffer,h.byteOffset,h.byteLength);let m=0;d.setUint32(m,c),m+=4,d.setUint32(m,o),m+=4,d.setUint16(m,r.length),m+=2;for(let e=0;e<r.length;++e)d.setUint32(m,r[e]),m+=4;d.setUint16(m,i),m+=2;const p=l(n,i),g=f(s),y=f(a);h.set(p,m),m+=p.length,h.set(g,m),m+=g.length,h.set(y,m),m+=y.length,e._assert(m===u,"totalSize miscounts"),this.paused||t(h)},this._dataToSend.length){for(let[e,t]of this._dataToSend)this._dataSend(e,t);this._dataToSend.length=0}})),n.on("data",i(((t,n)=>{const s=this._feedback.shift();if(!s)return console.warn("got feedback that we did not give data for");let r;if(t&&t.length>8){const e=new DataView(t.buffer,t.byteOffset,t.byteLength);let n=0;const s=e.getUint16(n);n+=2;const o=e.getUint32(n);n+=4;const i=a(e.getUint16(n));n+=2;for(let t=0;t<i.length;++t)i[t]=e.getUint32(n),n+=4;r=c(t.subarray(n),s),o===this._remotePartSize&&function(e,t){if(!Array.isArray(e)||!Array.isArray(t)||e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(i,this._remoteCellShape)||(this._remotePartSize=o,this._remoteCellShape=i,this._opts.partSize=o,this._opts.userParts=i[0]/o|0,this._opts.nameParts=i[1]/o|0,this._opts.dataSize=i[i.length-1],this.resume(this._opts))}const[o,i,l]=s;o&&r?(r.length>o.length&&(r=r.subarray(0,o.length)),o.set(r),o.length>r.length&&o.fill(0,r.length)):o&&o.fill(0),e.meta.metric("processing latency, ms",performance.now()-l),i()}))),n}))))}}onValues(e,t,n){this._dataSend?this._dataSend(t,this.bytesPerValue):this._dataToSend.push([t,this.bytesPerValue]),this._feedback.push([n,e,performance.now()])}}return t(InternetHandler,{broadcastChannel:t((function e(t=null){const n=e.id||(e.id=String(Math.random()).slice(2)+String(Math.random()).slice(2)),s=new BroadcastChannel("sn-internet-broadcast-channel");let a,r;const o={send(e,t=null){s.postMessage({tabId:n,dst:t,msg:e})},close(){clearInterval(a),s.close(),r&&r.forEach((e=>e.onclose&&e.onclose()))},onopen:null,onmessage:null,onclose:null};if(s.onmessage=e=>{const t=e.data;null!=t.dst&&t.dst!==n||t.tabId!==n&&o.onmessage&&o.onmessage({data:t.msg},t.tabId)},setTimeout((()=>o.onopen&&o.onopen()),0),!t)return o;r=Object.create(null),a=setInterval((()=>{const e=performance.now();for(let t of Object.keys(r)){const n=r[t];e-n.lastTouched>6e4&&(delete r[t],n.onclose&&n.onclose())}}),6e4),o.onmessage=(e,n)=>{r[n]||(t.signal(r[n]={tabId:n,lastTouched:0,send(e){o.send(e,this.tabId)},close(){delete r[this.tabId]},onopen:null,onmessage:null,onclose:null}),setTimeout((()=>r[n].onopen&&r[n].onopen()),0)),r[n].lastTouched=performance.now(),r[n].onmessage&&r[n].onmessage(e)}}),{docs:"Connects to all browser tabs, one connection per handler. Signals via a [`BroadcastChannel`](https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API). (Not in Safari.)"}),consoleLog:t((function e(t=null){if(e.did||(console.log("Carry around WebRTC signals manually, through the JS console."),console.log("    Please triple-click and copy each message, then paste at the other end."),e.did=!0),!t){const e={send(e){console.log(`internetSensor(${e})`)},close(){},noTrickle:!0};return setTimeout((()=>e.onopen&&e.onopen()),0),self.internetHandler=t=>e.onmessage&&e.onmessage({data:JSON.stringify(t)}),e}self.internetSensor=e=>{const n={send(e){console.log(`internetHandler(${e})`)},close(){},noTrickle:!0};setTimeout((()=>{n.onopen&&n.onopen(),n.onmessage&&n.onmessage({data:JSON.stringify(e)})}),0),t.signal(n)}}),{docs:"[`console.log`](https://developer.mozilla.org/en-US/docs/Web/API/Console/log) and `self.internetSensor(messageString)` and `self.internetHandler(messageString)` is used to make the user carry signals around."}),webSocket:t((function(e){return t=>new WebSocket(e)}),{docs:"Signals via a [`WebSocket`](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket). Have to pass it the URL before passing it as the `signaler` option."})}),Object.defineProperty(InternetSensor,"name",{value:"Internet",configurable:!0,writable:!0}),Object.defineProperty(InternetHandler,"name",{value:"Internet",configurable:!0,writable:!0}),{sensor:InternetSensor,handler:InternetHandler};function a(e){return n.length?(n[n.length-1].length=e,n.pop()):new Array(e)}function r(e){Array.isArray(e)&&n.length<16&&(e.length=0,n.push(e))}function o(t,n=16777216){let s=0;const a=new Uint8Array(65536),r=new DataView(a.buffer,a.byteOffset,a.byteLength);return function(o){if(e._assert(o.length<=n,"Message is too long!"),"closing"===t.readyState||"closed"===t.readyState)return;const i=Math.ceil((o.length-2)/65532);let l=0;for(let e=0,n=0;e<i;++e){r.setUint16(0,s),r.setUint16(2,e),0===e&&r.setUint16(4,i);let c;for(c=0===e?6:4;c<a.length&&n<o.length;++c,++n)a[c]=o[n];l+=c;try{t.send(c>=a.length?a:a.subarray(0,c))}catch(e){console.warn("Packet-part-sending failed",e)}}++s,s>=65536&&(s=0),e.meta.metric("sent, bytes/step",l)}}function i(t,n=50,s=16777216){const o=Object.create(null);let i=0,l=null;return function c(u){if(u instanceof Uint8Array&&(e._assert(!u.byteOffset),u={data:u.buffer}),u.data instanceof Blob)return u.data.arrayBuffer().then((e=>c({data:e})));e._assert(u.data instanceof ArrayBuffer,"Got non-ArrayBuffer data");const h=new DataView(u.data),d=h.getUint16(0),f=h.getUint16(2);if(d<i)return;let m;if(0===f){const e=h.getUint16(4);if(!e||e*(h.length-6)>s)return;o[d]&&r(o[d]),m=o[d]=a(1+e),m[0]=e,m[0]&&!m[1+f]&&--m[0],m[1+f]=h}else{if((1+f+1)*(h.length-4)>s)return;o[d]||(o[d]=a(1+f+1),o[d][0]=null),m=o[d],m[0]&&!m[1+f]&&--m[0],m[1+f]=h}d>i&&null==l&&(l=performance.now());let p=null!=l&&performance.now()-l>n&&function(){for(let e=i+1;e<=i+16;++e)if(o[65535&e])return!0;return!1}();for(;o[i]&&0===o[i][0]||p;){const e=o[i];let n=Array.isArray(e)&&0===e[0];if(n)for(let t=1;t<e.length;++t)if(!e[t]){n=!1;break}if(n){let n=0;for(let t=1;t<e.length;++t)n+=e[t].byteLength-(1===t?6:4);const s=new Uint8Array(n);for(let t=1,n=0;t<e.length;++t){const a=1===t?6:4,r=e[t].byteLength-a;for(let o=0;o<r;++o)s[n+o]=e[t].getUint8(a+o);n+=r}r(o[i]),o[i]=null,t(s,i)}else o[i]&&(r(o[i]),o[i]=null),t(null,i);i=i+1&65535,p=!1,l=null}}}function l(t,n=0){if(e._assert(t instanceof Float32Array),!n)return d(new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n);e._assert(1===n||2===n);const s=1===n?new Uint8Array(t.length):new Uint16Array(t.length),a=1===n?255:65535;for(let e=0;e<s.length;++e)s[e]=Math.max(0,Math.min(Math.round((t[e]+1)/2*a),a));return 1===n?s:d(new Uint8Array(s.buffer,s.byteOffset,s.byteLength),n,!0)}function c(t,n=0){if(e._assert(t instanceof Uint8Array),!n)return t=d(t,n),new Float32Array(t.buffer,t.byteOffset,t.byteLength/4|0);e._assert(1===n||2===n,n),2===n&&(t=new Uint16Array(d(t,n).buffer));const s=new Float32Array(t.length),a=1===n?255:65535;for(let e=0;e<s.length;++e)s[e]=t[e]/a*2-1;return s}function u(e,t=0){if(!t)return"number"==typeof e?new Float32Array(e).fill(-1):e;const n=1===t?255:65535;if("number"==typeof e)(e=new Float32Array(e)).fill(1/n-1);else for(let t=0;t<e.length;++t)e[t]+=1/n;return e}function h(t,n=0){if("number"==typeof t){t=new Float32Array(t);for(let e=0;e<t.length;++e)t[e]=2*Math.random()-1}const s=c(l(t,n),n),a=u(t.length,n);e._assert(t.length===s.length,"Unequal lengths");for(let e=0;e<t.length;++e)if(!(Math.abs(t[e]-s[e])<=a[e]+1))return t[e]+" ≠ "+s[e];return!0}function d(t,n,s=!1){if(void 0===d.bigEnd){const e=new ArrayBuffer(2),t=new Uint16Array(e),n=new Uint8Array(e);t[0]=258,d.bigEnd=1===n[0]}if(e._assert(t instanceof Uint8Array,"Bad byte-array"),d.bigEnd||1===n)return t;if(s||(t=new Uint8Array(t)),2===n)for(let e=0;e<t.length;e+=2)[t[e+0],t[e+1]]=[t[e+1],t[e+0]];else if(0===n||4===n)for(let e=0;e<t.length;e+=4)[t[e+0],t[e+1],t[e+2],t[e+3]]=[t[e+3],t[e+2],t[e+1],t[e+0]];return t}function f(e){const t=new Uint8Array(Math.ceil(e.length/8));for(let n=0;n<t.length;++n){const s=8*n;t[n]=e[s+0]<<7|e[s+1]<<6|e[s+2]<<5|e[s+3]<<4|e[s+4]<<3|e[s+5]<<2|e[s+6]<<1|e[s+7]<<0}return t}function m(e){const t=a(8*e.length);for(let n=0;n<e.length;++n){const s=8*n;t[s+0]=!!(128&e[n]),t[s+1]=!!(64&e[n]),t[s+2]=!!(32&e[n]),t[s+3]=!!(16&e[n]),t[s+4]=!!(8&e[n]),t[s+5]=!!(4&e[n]),t[s+6]=!!(2&e[n]),t[s+7]=!!(1&e[n])}return t}}function init$2(e){return class LimitFPS extends e.Transform{static docs(){return"Limits steps-per-second.\n\nUseful if you don't want to record ten thousand steps per second, almost none of which convey any useful information.\n\nOptions:\n- `hz = 60`: max frequency."}static options(){return{hz:{"60 ":()=>60,"30 ":()=>30,"10 ":()=>10,"3 ":()=>3}}}resume(e){return e&&(e.onValues=LimitFPS.onValues,this.hz=e.hz||3,this.last=performance.now()),super.resume(e)}static onValues(e,t){const n=performance.now(),s=1e3/this.hz;if(n-this.last>s)this.last=n,e();else{const t=Math.max(0,s-(n-this.last)-5);setTimeout(LimitFPS.resume,t,e,this.last=s+this.last)}}static resume(e,t){e()}}}function init$1(e){return class Time extends e.Transform{static docs(){return"Reports start & end times of when each data cell was collected.\n\n[Depends on the user's system time, not synchronized explicitly.](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/Date)\n\nReserve at least 1 of `userParts` for this.    \nWith at least 24 `partSize`, the augmentation looks like this (down is time):    \n![Sine-waves of exponentially-decreasing frequency.](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABz1JREFUeF7tW3tIl1cYPnmpaFkha42mZDFqEcJGa9moqFgWrVkNosVqFBZNZV2M1WhYq9aSREbQrNgKKhCrkeaC0mDViiJiYBfLS/fykt3VLmbm4Dnvo/N8HD613IJj/zznfL+f8eM97/e+z/u87+mglKpXDv/r0G4A8YATJ07AD6KiooC3bt0CnjlzBnj27FlgUVER8ObNm8Dbt28DHz58CHz06BHw6dOnwGfPngGfP38OrKurA7548QJYX68d0Ib48F//+D3zeWv3DR7gvAFqxIS9BLMOH8Zq5MiRwLt37wLpEUR6xI0bN/A5PeLBgwfYv+4e0eABzhtgwYIFOLGf168HThRP+GL7dqymT58OfPLkCTA/Px94+vRpYEFBAfD69etAxpD79+9jX11dDWRsqKnRJrfFBr8YIT/PAy2NEQ0e0G4A8YDs7GxY9eKVK8B3xcYbDxzAKjo6GsiTZXZgTCgsLMTnjAkVFRXYtzQmMFu0NEvQJZrrCR4PcNYADIKBkq9TgoJgzPFi0jjhB+np6XgSEREBvHbtGpCx4Ny5c9qDLl4ElpaWAu/cuQOsrKwEPn78GMiYUFtbiz1jAmOAiebJ2k66xR7gvAFIhOKHDcNJzEhNBX6zeDFwtnjCiE2b9H62fsKTO3/+fBNPuHDhQhMPsWUFZhUyRv5/JmNsq6zgYYLOGkAOWLn2KniqQWcNoGtBpZaNHg0MCAgA8t3789Ah7AfL95IyM7GKiYkBMrozCzArkBeQIZq8wGSItuqxrXhBYwxw3QDk5ozCeV27wiThkudr+vTBPkcMdXnRIqxWrFgB7NKlC5AnTg9gdrgizLKsrAzfu3fvHrCqqgrIbGD+Dp68n44gP6tBV+De73ljNSjFibMG0LWgUprXKfWLYIgwt++7dcOT+fI8ZuBArDIlFgwYMAB71gD0ANYKZIYlJSX4nskMqRvQAxgLbB5g8gK/k7Yxw8ZaoN0A2gI/iCHe7tQJq9jYWGBubi6wUDh+f/nehv37sRo3bhzQViVSObJlg+YqR686G3g8wFkD8N2bN28eTjIlJQW4pGdP4PidO4GfTpsGXCoe0E9qhvj4eDzhu8ZaIC8vD8+pGF29ehX78vLyJh5jZoPW1gbys5qdDTxZwFkDkAn2M/oBg8eOhVE7S/1+SvK91nmUyp45E5gqnhAaGoo9oz49gBoi+QB1AvIBUyfw4wP0tJfNBh4m6KwB+O64xgc81aCzBqAi9I4oQmHiEp8Jfr5lC1Zxwgu0sqeUzhFK7TtyBMhOEjtEtt7i69JJ8ihCzhqAQsiPSUk4yaDVq4F1y5cD09LSgKz/t2zdiv0n4gGxohZPnToVT6j6NreDxL4B9QFTK2yrDpKnN+isAdgaS0hIwAnm5OjKf+7cucDVnTvrd1yefyTc/yfxgNC1a7GaP1/Xi1SUyAhZHXJvMkLyAdMDzB6irW9gdpDkZ/kyQk9nyHkDhEl3eKF0aljFhQwaBKN2k75/cY8e2Gv1X6m/5swBJicnA7t37w4sLi4G0gP8GCFrAsYQP0Zo6xe02gOcNQCzgO7yK5UwfDiwob6XeQAlsz1pohp/KN//btQorLZt2wYMDw8H8l1nTUDV+NKlS/icNQEnUFgTmApRW/UOPVnAWQOQCZK5vS+6gJ7/UEpHAKXCRCVeKCrxBnk+pHdvrA7IHEFkZCT21ADN7jFjAz83p838usd+KrEtK5ixwcMEnTUALeNaTeCpBp01ABWhy+IKcdIH+EP6AmvH61kRvpudRDXOPXgQz4fI3y3bswerSZMmAc2eoTlLZE6VmTWB38Tpy6rEHkXIWQOQcR2Tk/1AendhovHlHD2KE40bMQL41bp1wEVLlui9eMCozZuxmjVrFpD521YVcsbo/5og8ajCzhqAUtiYvXtxcsHBwUC+YxMmTMB+fWCgfufFI94Tj9DzpUp1XLUKmJiYCAySaTO/qpBdYzJPW9eY1eCrqgo9naF2A4gHpEsUz5B5fjK2qjCtFr4p9wRKpXN0Sjzg77g4rNasWQMMCQkBsqq0VYXm3ACzR1vPDVg9wDkDmFlATwop9fuuXUBG8aSVK7EPkKowS6rCN+T7GydPxooaYq9e+gYCqz/TA2xVoZ8uYGqEre0UWbOAcwYwmaCe+1TqN0HqBXryV6kguQuU3LEj9pr3KTVniOaEGRkZwL59+wLJ+Gy6gG1yxK8qfNmZYisTdM4AcoDKNV3AWg26ogtYBRFy+UCpDfSNH6V0v0ip0fv2Ab+eqG8XUR3WWrBSx44fBw6TXiMnRM3pMSpDZq/wv7qH2G4AXp01VWFG8y9PaY6nJ4eUekswfqmeEtqxY4eO8nIzpJ98/qt0kMbKhAk7P+YdI/Peoe2OERkhq0vbvYKW3jGyqsLOGYC9QTZGxvCkhw7F6tuTJ4FZM2YAeZK8O5QlNcTH8neJu3djNWXKFCB7fs2dJmdVyP5AW3WLPb1B1wzwD7XJyQ9o5gXsAAAAAElFTkSuQmCC)    \nWith less, it has to improvise, with max resolution being 1/8sec, and min resolution at least 8sec.\n\nOptions:\n- `timing = () => +new Date()/1000`: provides the seconds used to annotate data.\n"}static options(){return{timing:{Date:()=>()=>+new Date/1e3,"Since page load":()=>()=>performance.now()/1e3,"Count steps":()=>function e(){return e.n=e.n+1||1}}}}resume(e){return e&&(this.timing=e.timing||(()=>+new Date/1e3),e.onValues=Time.onValues,this.last=this.timing()),super.resume(e)}static onValues(e,{data:t,cellShape:n,partSize:s}){if(!t.length)return e();const a=n[0],r=a/s|0;if(!r)return e();const o=this.timing();let i,l;r>=3?(i=s*(r-2)||1,l=i+s):(i=s*(r-1)||1,l=i+(s/2|0)),Time.fill(t,i,l,this.last),Time.fill(t,l,a,o);const c=n.reduce(((e,t)=>e+t)),u=t.length/c|0;for(let e=1;e<u;++e)t.copyWithin(i+e*c,i,a);this.last=o,e()}static fill(e,t,n,s){if(n-t>=24){const a=1e3*s*2*Math.PI/10;for(let s=t,r=1;s<n;++s,r*=1.4)e[s]=Math.sin(a/r)}else{const a=n-t>=8?2:n-t>=4?4:16,r=8*s*2*Math.PI;for(let s=t,o=1;s<n;++s,o*=a)e[s]=Math.sin(r/o)}}}}function init(e){const t=Object.assign,n=1048576,s=[];class StorageSensor extends e.Sensor{static docs(){return"Loads data from storage.\n\nNote that this does not separate steps but just outputs data in ~1MiB chunks, so it is likely to sound different when visualized with `sn.Sensor.Sound`.\n\nUses [`indexedDB`.](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)\n\nOptions:\n- `filename = 'sn'`: which file was saved.\n- `pauseOnEnd = false`: to only process the file once, use this.\n- `randomEveryNCells = null`: if an integer, `.random()` will be called periodically and at the start.\n\nProperties, to get/set at will:\n- `1 <= .nextChunk < .maxChunks`. Note that changing this will not clear the chunk queue, so the change may take a while to become visible unless you `.flush()`.\n- `.maxChunks`\n\nMethods:\n- `.random()`: sets `.nextChunk` to a random point.\n- `.flush()`: makes the transition to another chunk instant, at the cost of a fetching delay.\n"}static options(){return{filename:{sn:()=>"sn","1 ":()=>"1","2 ":()=>"2","3 ":()=>"3","4 ":()=>"4"},pauseOnEnd:{No:!1,Yes:!0},randomEveryNCells:{No:()=>null,"10000 ":()=>1e4,"1000000 ":()=>1e6,"100000000 ":()=>1e8}}}random(){this.nextChunk=1+(Math.random()*(this.maxChunks-1)|0)}flush(){this._chunks=[]}pause(e=!1){return e||(this.file&&Promise.resolve(this.file).then((e=>e.close())),this.file=this.filename=null),super.pause()}resume(t){const n=(t?t.filename:this.filename)||"sn";t&&(e._assert("string"==typeof n),t.values=0,t.emptyValues=0,t.name=[],t.onValues=this.onValues,t.noFeedback=!0,this.pauseOnEnd=!!t.pauseOnEnd,this.randomEveryNCells=t.randomEveryNCells,this._chunks||(this._chunks=[],this._chunksToGet=0));try{return super.resume(t)}finally{if(n!==this.filename){this._warned=!1,this.file&&Promise.resolve(this.file).then((e=>e.close())),this.filename=n;const t=this.file=i(n).then((async n=>{if(t!==this.file)return n;let s=await u(n,0);if(t!==this.file)return n;if(!s)return this.pause(),n;const a=new DataView(s.buffer,s.byteOffset,s.byteLength);let r=0;const o=a.getUint16(r);r+=2;const i=a.getUint32(r);r+=4;const l=new Array(a.getUint16(r));r+=2;for(let e=0;e<l.length;++e)l[e]=a.getUint32(r),r+=4;e._assert(0===o||1===o||2===o),this._bytesPerValue=o,this._partSize=i,this._cellShape=l;const h=l.reduce(((e,t)=>e+t));return this._chunkCells=Math.floor(8388608/(8*(o||4)*h+2)),this.nextChunk=1,this.maxChunks=await c(n),t!==this.file?n:(this.cellsUntilReset=this.randomEveryNCells||0,this.cellsUntilReset&&this.random(),this.file=n)}))}}}onValues(t){if(e._deallocF32(t),!this.file||this.file instanceof Promise||!this.filename)return;for(;this._chunks.length+this._chunksToGet<8;){const e=this._chunks;if(u(this.file,this.nextChunk++).then((t=>{t&&e.push(t),--this._chunksToGet})),++this._chunksToGet,this.nextChunk>=this.maxChunks&&(this.nextChunk=1,this.pauseOnEnd))return this.pause();if(Math.random()<.01){const e=this.file;c(e).then((t=>this.file===e&&(this.maxChunks=t)))}}if(!this._chunks.length)return;const n=this._chunks.shift();this.sendRawCallback(null,(function({cellShape:t,partSize:s,summary:a},o,i,l,c){const u=t.reduce(((e,t)=>e+t)),h=this._bytesPerValue||4,d=this._cellShape.reduce(((e,t)=>e+t)),f=this._chunkCells*d,m=Math.ceil(this._chunkCells/8),p=f*h,g=p+m,y=r(n.subarray(p,g)),b=r(n.subarray(g,g+m));let k=f/d|0;for(y.length=k,b.length=k;k&&y[k-1]&&b[k-1];)--k,y.pop(),b.pop();if(!k)return;const S=e._allocF32(k*u),w=new DataView(n.buffer,n.byteOffset,n.byteLength);for(let e=0;e<k;++e){const n=e*u,s=n+u,a=e*d,r=a+d,o=n+(u-t[t.length-1]),i=a+(d-this._cellShape[this._cellShape.length-1]);for(let e=a,t=n;e<i&&t<o;++e,++t)S[t]=1===h?w.getUint8(e):2===h?w.getUint16(2*e):w.getFloat32(4*e);for(let e=i,t=o;e<r&&t<s;++e,++t)S[t]=1===h?w.getUint8(e):2===h?w.getUint16(2*e):w.getFloat32(4*e);this.cellsUntilReset&&(--this.cellsUntilReset||this.random())}const v=function(e,t=0){if(!t)return"number"==typeof e?new Float32Array(e).fill(-1):e;const n=1===t?255:65535;if("number"==typeof e)(e=new Float32Array(e)).fill(1/n-1);else for(let t=0;t<e.length;++t)e[t]+=1/n;return e}(k*u,this._bytesPerValue);i.send(this,l,c,S,v,y,b)}))}}class StorageHandler extends e.Handler{static docs(){return"Saves data to storage.\n\nData of no-data cells is already replaced with feedback, if the main handler is present to give it.\n\nUses [`indexedDB`.](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)\n\nOptions:\n- `filename = 'sn'`: which file to append to.\n- `bytesPerValue = 0`: 1 to store as uint8, 2 to store as uint16, 0 to store as float32. Only relevant when first creating the file.\n\nFunctions:\n- `sn.Handler.Storage.download(filename)`: downloads the file to the OS, importing the [StreamSaver](https://github.com/jimmywarting/StreamSaver.js?) library.\n- `sn.Handler.Storage.upload(filename, file)`: gets the [file](https://developer.mozilla.org/en-US/docs/Web/API/File) from the OS, overwriting what is already in `filename`; to append, upload to a temporary location, then sense from there and handle to elsewhere.\n- [`navigator.storage.persist()`](https://developer.mozilla.org/en-US/docs/Web/API/StorageManager/persist)\n- [`indexedDB.deleteDatabase(filename)`](https://developer.mozilla.org/en-US/docs/Web/API/IDBFactory/deleteDatabase)\n"}static options(s){const a=document.createElement.bind(document),r=a("div"),o=setInterval((async()=>{if("visible"!==document.visibilityState)return;if("hidden"===getComputedStyle(r).visibility)return;const e=await i(s.filename),t=await c(e)*n,a=t/1024,l=a/1024,u=l/1024,h=u/1024;r.textContent=h>=1?"🌏 "+h.toFixed(2)+" TiB":u>=1?"🍖 "+u.toFixed(2)+" GiB":l>=1?"🍗 "+l.toFixed(2)+" MiB":a>=1?"🍬 "+a.toFixed(2)+" KiB":"🍴 "+t.toFixed(2)+" bytes",e.close(),r.isConnected||clearInterval(o)}),200),u=t(a("button"),{onclick(){navigator.storage.persist()}});u.append("⚙ Request persistence");const h=t(a("button"),{onclick(){e.Handler.Storage.download(s.filename)}});h.append("▼ To file");const d=t(a("input"),{type:"file",onchange(){this.files&&this.files.length&&e.Handler.Storage.upload(s.filename,this.files[0])}});d.append("▲ Replace from file");const f=t(a("button"),{onclick(){confirm("Delete "+s.filename+"?")&&l(s.filename)}});return f.append("🔥 No more data"),{filename:{sn:()=>"sn","1 ":()=>"1","2 ":()=>"2","3 ":()=>"3","4 ":()=>"4"},bytesPerValue:{"float32 (4× size)":()=>0,"uint16 (2× size)":()=>2,"uint8 (1× size)":()=>1},fileSize:r,persist:u,download:h,upload:d,delete:f}}static async download(e,t=".num"){const s=await i(e);try{const a=await c(s),r=await d();r.WritableStream=r.WritableStream,r.TransformStream=r.TransformStream;const o=r.createWriteStream(e+t,{size:a*n}).getWriter();for(let e=0;e<a;++e)await o.write(await u(s,e));o.close()}finally{s.close()}}static async upload(t,s){e._assert("string"==typeof t);const a=Math.ceil(s.size/n);await l(t);const r=await i(t);try{for(let e=0;e<a;++e)h(r,e,new Uint8Array(await s.slice(e*n,(e+1)*n).arrayBuffer()))}finally{r.close()}}pause(e=!1){if(!e){if(Array.isArray(this._chunks))for(;this._chunks.length>0;)this.saveChunk(this._chunks.shift());this.file&&Promise.resolve(this.file).then((e=>e.close())),this.file=this.filename=null}return super.pause()}resume(t){const n=(t?t.filename:this.filename)||"sn";if(t){const s=t.bytesPerValue||0;e._assert(0===s||1===s||2===s),e._assert("string"==typeof n),t.onValues=this.onValues,t.noFeedback=!0,this.bytesPerValue=s,this._chunks||(this._chunks=[])}try{return super.resume(t)}finally{if(n!==this.filename){this._warned=!1,this._initResolve&&this._initResolve(),this._initPromise=new Promise((e=>this._initResolve=e)),this.file&&Promise.resolve(this.file).then((e=>e.close())),this.filename=n;const t=this.file=i(n).then((async n=>{if(t!==this.file)return n;let s,a=await u(n,0);if(t!==this.file)return n;if(a)s=new DataView(a.buffer,a.byteOffset,a.byteLength);else{a=o().fill(0),s=new DataView(a.buffer,a.byteOffset,a.byteLength);let e=0;s.setUint16(e,this.bytesPerValue),e+=2,s.setUint32(e,this.partSize),e+=4,s.setUint16(e,this.cellShape.length),e+=2;for(let t=0;t<this.cellShape.length;++t)s.setUint32(e,this.cellShape[t]),e+=4;if(await h(n,0,a),t!==this.file)return n}let r=0;const i=s.getUint16(r);r+=2;const l=s.getUint32(r);r+=4;const d=new Array(s.getUint16(r));r+=2;for(let e=0;e<d.length;++e)d[e]=s.getUint32(r),r+=4;e._assert(0===i||1===i||2===i),this._bytesPerValue=i,this._partSize=l,this._cellShape=d;const f=d.reduce(((e,t)=>e+t));return this._chunkCells=Math.floor(8388608/(8*(i||4)*f+2)),this.nextChunk=await c(n),t!==this.file?n:(this.nextCell=999999999,this._initPromise=null,this._initResolve(),this.file=n)}))}}}async onValues(e,{data:t,noData:n,noFeedback:s,cellShape:a,partSize:r}){if(this._initPromise&&await this._initPromise,!this.filename)return e();const i=r!==this._partSize||!function(e,t){if(!Array.isArray(e)||!Array.isArray(t)||e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(a,this._cellShape);!this._warned&&i&&(console.warn("Cell shape differs from what it is in the file: got",r,a,"but had",this._partSize,this._cellShape),this._warned=!0);const l=a.reduce(((e,t)=>e+t)),c=t.length/l|0,u=this._bytesPerValue||4,h=this._cellShape.reduce(((e,t)=>e+t)),d=this._chunkCells*h*u,f=d+Math.ceil(this._chunkCells/8),m=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let e=0;e<c;++e){(this.nextCell>=this._chunkCells||!this._chunks.length)&&(this._chunks.push(o().fill(0)),this.nextCell=0);const t=this._chunks[this._chunks.length-1],r=e*l,c=(e+1)*l,p=this.nextCell*h,g=++this.nextCell*h;if(i){const e=r+(l-a[a.length-1]),n=p+(h-this._cellShape[this._cellShape.length-1]);for(let s=p*u,a=r*u;s<n*u&&a<e*u;++s,++a)t[s]=m[a];for(let s=n*u,a=e*u;s<g*u&&a<c*u;++s,++a)t[s]=m[a]}else for(let e=p*u,n=r*u;e<g*u&&n<c*u;++e,++n)t[e]=m[n];1===this.nextCell&&t.fill(255,d);const y=this.nextCell-1,b=n[e],k=s[e],S=y>>>3,w=7&y;!1===b&&(t[d+S]=t[d+S]&~(1<<w)),!1===k&&(t[f+S]=t[f+S]&~(1<<w))}for(;this._chunks.length>1;)this.saveChunk(this._chunks.shift());e()}saveChunk(t){if(!this.file)return;e._assert(!(this.file instanceof Promise));const n=this._bytesPerValue,s=this._cellShape.reduce(((e,t)=>e+t)),r=this._chunkCells;a(t.subarray(0,r*s*(n||4)),n,!0),h(this.file,this.nextChunk++,t)}}return Object.defineProperty(StorageSensor,"name",{value:"Storage",configurable:!0,writable:!0}),Object.defineProperty(StorageHandler,"name",{value:"Storage",configurable:!0,writable:!0}),{sensor:StorageSensor,handler:StorageHandler};function a(t,n,s=!1){if(void 0===a.bigEnd){const e=new ArrayBuffer(2),t=new Uint16Array(e),n=new Uint8Array(e);t[0]=258,a.bigEnd=1===n[0]}if(e._assert(t instanceof Uint8Array,"Bad byte-array"),a.bigEnd||1===n)return t;if(s||(t=new Uint8Array(t)),2===n)for(let e=0;e<t.length;e+=2)[t[e+0],t[e+1]]=[t[e+1],t[e+0]];else if(0===n||4===n)for(let e=0;e<t.length;e+=4)[t[e+0],t[e+1],t[e+2],t[e+3]]=[t[e+3],t[e+2],t[e+1],t[e+0]];return t}function r(e){const t=new Array(8*e.length);for(let n=0;n<e.length;++n){const s=8*n;t[s+0]=!!(1&e[n]),t[s+1]=!!(2&e[n]),t[s+2]=!!(4&e[n]),t[s+3]=!!(8&e[n]),t[s+4]=!!(16&e[n]),t[s+5]=!!(32&e[n]),t[s+6]=!!(64&e[n]),t[s+7]=!!(128&e[n])}return t}function o(){return s.length?s.pop():new Uint8Array(n)}function i(t){e._assert("string"==typeof t);const n=indexedDB.open(t);return new Promise(((e,t)=>{n.onerror=e=>t(e.target.error),n.onupgradeneeded=e=>e.target.result.createObjectStore("sn-storage"),n.onsuccess=t=>e(t.target.result)}))}function l(t){e._assert("string"==typeof t);const n=indexedDB.deleteDatabase(t);return new Promise(((e,t)=>{n.onerror=e=>t(e.target.error),n.onsuccess=t=>{e(t.target.result)}}))}function c(e){const t=e.transaction("sn-storage","readonly").objectStore("sn-storage");return new Promise(((e,n)=>{const s=t.count();s.onsuccess=()=>e(s.result),s.onerror=n}))}function u(e,t){const n=e.transaction("sn-storage","readonly").objectStore("sn-storage");return new Promise(((e,s)=>{const a=n.get(t);a.onsuccess=()=>e(a.result),a.onerror=s}))}function h(e,t,a){if(a.length!==n){const e=a;a=o().fill(255);for(let t=0;t<n;++t)a[t]=e[t]||0}const r=e.transaction("sn-storage","readwrite",{durability:"relaxed"}),i=r.objectStore("sn-storage");r.oncomplete=()=>{return e=a,void(s.length<16&&s.push(e));var e},i.put(a,t),r.commit()}function d(){return d.did?d.did:d.did=new Promise((e=>{const t=document.createElement("script"),n=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/ponyfill.min.js",n.src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/StreamSaver.min.js",document.head.append(t,n);const s=setInterval((()=>{self.streamSaver&&self.WebStreamsPolyfill&&(clearInterval(s),e(self.streamSaver))}),50)}))}}!function(e){var t=function(e,t){var n=e[0],s=e[1],a=e[2],r=e[3];s=((s+=((a=((a+=((r=((r+=((n=((n+=(s&a|~s&r)+t[0]-680876936|0)<<7|n>>>25)+s|0)&s|~n&a)+t[1]-389564586|0)<<12|r>>>20)+n|0)&n|~r&s)+t[2]+606105819|0)<<17|a>>>15)+r|0)&r|~a&n)+t[3]-1044525330|0)<<22|s>>>10)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s&a|~s&r)+t[4]-176418897|0)<<7|n>>>25)+s|0)&s|~n&a)+t[5]+1200080426|0)<<12|r>>>20)+n|0)&n|~r&s)+t[6]-1473231341|0)<<17|a>>>15)+r|0)&r|~a&n)+t[7]-45705983|0)<<22|s>>>10)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s&a|~s&r)+t[8]+1770035416|0)<<7|n>>>25)+s|0)&s|~n&a)+t[9]-1958414417|0)<<12|r>>>20)+n|0)&n|~r&s)+t[10]-42063|0)<<17|a>>>15)+r|0)&r|~a&n)+t[11]-1990404162|0)<<22|s>>>10)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s&a|~s&r)+t[12]+1804603682|0)<<7|n>>>25)+s|0)&s|~n&a)+t[13]-40341101|0)<<12|r>>>20)+n|0)&n|~r&s)+t[14]-1502002290|0)<<17|a>>>15)+r|0)&r|~a&n)+t[15]+1236535329|0)<<22|s>>>10)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s&r|a&~r)+t[1]-165796510|0)<<5|n>>>27)+s|0)&a|s&~a)+t[6]-1069501632|0)<<9|r>>>23)+n|0)&s|n&~s)+t[11]+643717713|0)<<14|a>>>18)+r|0)&n|r&~n)+t[0]-373897302|0)<<20|s>>>12)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s&r|a&~r)+t[5]-701558691|0)<<5|n>>>27)+s|0)&a|s&~a)+t[10]+38016083|0)<<9|r>>>23)+n|0)&s|n&~s)+t[15]-660478335|0)<<14|a>>>18)+r|0)&n|r&~n)+t[4]-405537848|0)<<20|s>>>12)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s&r|a&~r)+t[9]+568446438|0)<<5|n>>>27)+s|0)&a|s&~a)+t[14]-1019803690|0)<<9|r>>>23)+n|0)&s|n&~s)+t[3]-187363961|0)<<14|a>>>18)+r|0)&n|r&~n)+t[8]+1163531501|0)<<20|s>>>12)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s&r|a&~r)+t[13]-1444681467|0)<<5|n>>>27)+s|0)&a|s&~a)+t[2]-51403784|0)<<9|r>>>23)+n|0)&s|n&~s)+t[7]+1735328473|0)<<14|a>>>18)+r|0)&n|r&~n)+t[12]-1926607734|0)<<20|s>>>12)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s^a^r)+t[5]-378558|0)<<4|n>>>28)+s|0)^s^a)+t[8]-2022574463|0)<<11|r>>>21)+n|0)^n^s)+t[11]+1839030562|0)<<16|a>>>16)+r|0)^r^n)+t[14]-35309556|0)<<23|s>>>9)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s^a^r)+t[1]-1530992060|0)<<4|n>>>28)+s|0)^s^a)+t[4]+1272893353|0)<<11|r>>>21)+n|0)^n^s)+t[7]-155497632|0)<<16|a>>>16)+r|0)^r^n)+t[10]-1094730640|0)<<23|s>>>9)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s^a^r)+t[13]+681279174|0)<<4|n>>>28)+s|0)^s^a)+t[0]-358537222|0)<<11|r>>>21)+n|0)^n^s)+t[3]-722521979|0)<<16|a>>>16)+r|0)^r^n)+t[6]+76029189|0)<<23|s>>>9)+a|0,s=((s+=((a=((a+=((r=((r+=((n=((n+=(s^a^r)+t[9]-640364487|0)<<4|n>>>28)+s|0)^s^a)+t[12]-421815835|0)<<11|r>>>21)+n|0)^n^s)+t[15]+530742520|0)<<16|a>>>16)+r|0)^r^n)+t[2]-995338651|0)<<23|s>>>9)+a|0,s=((s+=((r=((r+=(s^((n=((n+=(a^(s|~r))+t[0]-198630844|0)<<6|n>>>26)+s|0)|~a))+t[7]+1126891415|0)<<10|r>>>22)+n|0)^((a=((a+=(n^(r|~s))+t[14]-1416354905|0)<<15|a>>>17)+r|0)|~n))+t[5]-57434055|0)<<21|s>>>11)+a|0,s=((s+=((r=((r+=(s^((n=((n+=(a^(s|~r))+t[12]+1700485571|0)<<6|n>>>26)+s|0)|~a))+t[3]-1894986606|0)<<10|r>>>22)+n|0)^((a=((a+=(n^(r|~s))+t[10]-1051523|0)<<15|a>>>17)+r|0)|~n))+t[1]-2054922799|0)<<21|s>>>11)+a|0,s=((s+=((r=((r+=(s^((n=((n+=(a^(s|~r))+t[8]+1873313359|0)<<6|n>>>26)+s|0)|~a))+t[15]-30611744|0)<<10|r>>>22)+n|0)^((a=((a+=(n^(r|~s))+t[6]-1560198380|0)<<15|a>>>17)+r|0)|~n))+t[13]+1309151649|0)<<21|s>>>11)+a|0,s=((s+=((r=((r+=(s^((n=((n+=(a^(s|~r))+t[4]-145523070|0)<<6|n>>>26)+s|0)|~a))+t[11]-1120210379|0)<<10|r>>>22)+n|0)^((a=((a+=(n^(r|~s))+t[2]+718787259|0)<<15|a>>>17)+r|0)|~n))+t[9]-343485551|0)<<21|s>>>11)+a|0,e[0]=n+e[0]|0,e[1]=s+e[1]|0,e[2]=a+e[2]|0,e[3]=r+e[3]|0},n=[],s=function(){this._dataLength=0,this._state=new Int32Array(4),this._buffer=new ArrayBuffer(68),this._bufferLength=0,this._buffer8=new Uint8Array(this._buffer,0,68),this._buffer32=new Uint32Array(this._buffer,0,17),this.start()},a=new Int32Array([1732584193,-271733879,-1732584194,271733878]),r=new Int32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);s.prototype.appendStr=function(e){for(var n,s=this._buffer8,a=this._buffer32,r=this._bufferLength,o=0;o<e.length;o++){if((n=e.charCodeAt(o))<128)s[r++]=n;else if(n<2048)s[r++]=192+(n>>>6),s[r++]=63&n|128;else if(n<55296||n>56319)s[r++]=224+(n>>>12),s[r++]=n>>>6&63|128,s[r++]=63&n|128;else{if((n=1024*(n-55296)+(e.charCodeAt(++o)-56320)+65536)>1114111)throw"Unicode standard supports code points up to U+10FFFF";s[r++]=240+(n>>>18),s[r++]=n>>>12&63|128,s[r++]=n>>>6&63|128,s[r++]=63&n|128}r>=64&&(this._dataLength+=64,t(this._state,a),r-=64,a[0]=a[16])}return this._bufferLength=r,this},s.prototype.appendAsciiStr=function(e){for(var n,s=this._buffer8,a=this._buffer32,r=this._bufferLength,o=0;;){for(n=Math.min(e.length-o,64-r);n--;)s[r++]=e.charCodeAt(o++);if(r<64)break;this._dataLength+=64,t(this._state,a),r=0}return this._bufferLength=r,this},s.prototype.appendByteArray=function(e){for(var n,s=this._buffer8,a=this._buffer32,r=this._bufferLength,o=0;;){for(n=Math.min(e.length-o,64-r);n--;)s[r++]=e[o++];if(r<64)break;this._dataLength+=64,t(this._state,a),r=0}return this._bufferLength=r,this},s.prototype.start=function(){return this._dataLength=0,this._bufferLength=0,this._state.set(a),this},s.prototype.end=function(e){var s=this._bufferLength;this._dataLength+=s;var a=this._buffer8;a[s]=128,a[s+1]=a[s+2]=a[s+3]=0;var o=this._buffer32,i=1+(s>>2);o.set(r.subarray(i),i),s>55&&(t(this._state,o),o.set(r));var l=8*this._dataLength;if(l<=4294967295)o[14]=l;else{var c=l.toString(16).match(/(.*?)(.{0,8})$/),u=parseInt(c[2],16),h=parseInt(c[1],16)||0;o[14]=u,o[15]=h}return t(this._state,o),e?this._state:function(e){for(var t,s,a,r="0123456789abcdef",o=n,i=0;i<4;i++)for(s=8*i,t=e[i],a=0;a<8;a+=2)o[s+1+a]=r.charAt(15&t),t>>>=4,o[s+0+a]=r.charAt(15&t),t>>>=4;return o.join("")}(this._state)};var o=new s;s.hashStr=function(e,t){return o.start().appendStr(e).end(t)},s.hashAsciiStr=function(e,t){return o.start().appendAsciiStr(e).end(t)},"5d41402abc4b2a76b9719d911017c592"!==s.hashStr("hello")&&console.error("YaMD5> this javascript engine does not support YaMD5. Sorry."),"object"==typeof e&&(e.YaMD5=s)}(typeof self!=""+void 0?self:global);var main=function(e){const t=Object.create(null),n=Object.assign,s=Object.create(null);let a=null;const r=Object.create(null);class _Packet{constructor(e,t,n){const s=[],a=[],r=g(t,n);Object.assign(this,{channel:e,summary:r,cellShape:t,cellSize:t.reduce(((e,t)=>e+t)),partSize:n,ch:y(e),dst:y(e,t,n,r),stage:0,mainHandler:null,handleStart:0,benchAtStart:null,transformI:0,prevCells:0,handlersLeft:0,handleStateMachine:this.handleStateMachine.bind(this),cells:0,sensorNeedsFeedback:!1,sensor:[],sensorData:[],sensorError:[],sensorIndices:[],noData:s,noFeedback:a,noDataIndices:[],input:{data:null,error:null,noData:s,noFeedback:a,cellShape:t,partSize:n},transformCells:[],transformExtra:[],transformCallback:[],feedback:null})}static init(e,t,n,s){const a=y(e,t,n,s);return a.packetCache.length?a.packetCache.pop():new _Packet(e,t,n,s)}deinit(){const e=this;e.stage=0,e.mainHandler=null,e.handleStart=0,e.benchAtStart=null,e.transformI=e.prevCells=e.handlersLeft=0,e.cells=0,e.sensorNeedsFeedback=!1,e.sensor.length=e.sensorData.length=e.sensorError.length=e.sensorIndices.length=e.noData.length=e.noFeedback.length=e.noDataIndices.length=0,e.input.data&&(d(e.input.data),e.input.data=null),e.input.error&&(d(e.input.error),e.input.error=null),e.transformCells.length=e.transformExtra.length=e.transformCallback.length=0,e.feedback&&(d(e.feedback),e.feedback=null);const t=y(e.channel,e.cellShape,e.partSize,e.summary);t.packetCache.length<64&&t.packetCache.push(e)}send(e,t,n,s,a,r,o){c(s instanceof Float32Array,"Data must be float32"),c(s.length%this.cellSize==0,"Data must be divided into cells"),c(null==a||a instanceof Float32Array,"Error must be null or float32"),c(null==a||s.length===a.length,"Error must be per-data-point"),e.feedbackCallbacks.push(t),e.feedbackNoFeedback.push(e.noFeedback),e.feedbackNamers.push(e.dataNamers),e.feedbackUnnamer.push(n);const i=s.length/this.cellSize|0;(Array.isArray(o)?o.some((e=>!e)):!o)&&(this.sensorNeedsFeedback=!0),this.sensor.push(e),this.sensorData.push(s),a&&(this.sensorError[this.sensorError.length-1]=a),this.sensorIndices.push(this.cells);for(let e=0;e<i;++e)this.noData.push(Array.isArray(r)?!!r[e]:!!r),this.noFeedback.push(Array.isArray(o)?!!o[e]:!!o);for(let e=0;e<i;++e)(Array.isArray(r)?r[e]:r)&&this.noDataIndices.push(this.cells+e);this.cells+=s.length/this.cellSize|0}static updateMean(e,t,n=12){const s=e[0]+1;return e[0]=Math.min(s,n),e[1]+=(t-e[1])/s,isFinite(e[1])||(e[0]=e[1]=0),e}handleStateMachine(e,n,s){const r=this,o=r.ch,i=r.dst;if(o.shaped[r.summary])for(;;)switch(r.stage){case 0:r.handleStart=performance.now(),r.benchAtStart=a,r.input.data=h(r.cells*r.cellSize),r.input.error=r.sensorError?h(r.cells*r.cellSize):null;for(let e=0;e<r.sensorData.length;++e){const t=r.sensorIndices[e]*r.cellSize;r.input.data.set(r.sensorData[e],t),r.input.error&&(r.sensorError[e]?r.input.error.set(r.sensorError[e],t):r.input.error.fill(-1,t,t+r.sensorData[e].length))}++i.stepsNow,r.stage=1;case 1:if(r.transformI<o.transforms.length){const e=o.transforms[r.transformI];if("function"==typeof e.onValues||"function"==typeof e.onFeedback)try{return r.prevCells=r.cells,r.transformCallback.push(e.onFeedback),r.stage=9,++r.transformI,"function"==typeof e.onValues?e.onValues(r.handleStateMachine,r.input):r.handleStateMachine()}catch(e){console.error(e)}}r.stage=2;case 2:if(r.mainHandler&&!r.mainHandler.noFeedback&&r.sensorNeedsFeedback?(r.feedback=h(r.cells*r.cellSize),r.feedback.set(r.input.data)):r.feedback=null,r.mainHandler)try{return r.stage=3,r.mainHandler.onValues(r.handleStateMachine,r.input,r.feedback)}catch(e){console.error(e)}r.stage=3;case 3:if(e?i.overscheduled=1:i.overscheduled*=.9,r.feedback)for(let e=0;e<r.noDataIndices.length;++e){const t=r.cellSize*r.noDataIndices[e],n=t+r.cellSize;for(let e=t;e<n;++e)r.input.data[e]=r.feedback[e]}r.stage=4;case 4:{const e=i.handlers,t=r.mainHandler;r.handlersLeft=0;for(let n=0;n<e.length;++n)e[n]!==t&&"function"==typeof e[n].onValues&&++r.handlersLeft;if(r.handlersLeft){r.stage=5;for(let n=0;n<e.length;++n)if(e[n]!==t&&"function"==typeof e[n].onValues)try{e[n].onValues(r.handleStateMachine,r.input)}catch(e){console.error(e)}return}r.stage=6;continue}case 5:if("number"==typeof e?(i.prevEnd-=e||0,i.overscheduled=1):i.overscheduled*=.9,--r.handlersLeft)return;r.stage=6;case 6:for(;r.transformCallback.length;){r.prevCells=r.transformCells.pop();const e=r.transformExtra.pop(),t=r.transformCallback.pop();if("function"==typeof t)try{return r.stage=10,t(r.handleStateMachine,r.input,r.feedback,e)}catch(e){console.error(e)}}r.stage=7;case 7:for(;r.sensor.length;)try{m(r.sensor.pop(),r.sensorData.pop(),r.sensorError.pop(),r.feedback,r.sensorIndices.pop()*r.cellSize,r.cellShape,r.partSize,r.summary)}catch(e){console.error(e)}r.stage=8;case 8:{if(--i.stepsNow,_Packet._handledBytes=(_Packet._handledBytes||0)+r.cells*r.cellSize*4,_Packet.stepsEnded=(_Packet.stepsEnded||0)+1,r.benchAtStart===a){let e=(i.lastUsed=performance.now())-r.handleStart;i.msPerStep[0]&&(e=Math.min(e,1.1*i.msPerStep[1]+11)),_Packet.updateMean(i.msPerStep,e),t.meta.metric("simultaneous steps",i.stepsNow+1),t.meta.metric("step processed data, values",r.cells*r.cellSize)}const e=!!r.cells,n=i.giveNextPacketNow,s=i.waitingSinceTooManySteps;return r.deinit(),e&&i.stepsNow<=1&&(i.tooFew=!0,n&&(clearTimeout(i.clearNextPacketNow),n())),s&&s()}case 9:{const t=e,a=n,o=s;if(a&&a!==r.input.data){c(a instanceof Float32Array),c(a.length%r.cellSize==0,"Bad data size"),r.input.error?(c(o instanceof Float32Array),c(a.length===o.length,"Data and error lengths differ")):c(!o);const e=a.length/r.cellSize|0;c(r.input.noData.length===e,"Must resize `noData` too"),c(r.input.noFeedback.length===e,"Must resize `noFeedback` too"),r.cells=e,d(r.input.data),r.input.data=a,r.input.error&&(d(r.input.error),r.input.error=o)}else a||c(!o);r.transformCells.push(r.prevCells),r.transformExtra.push(t),r.stage=1;continue}case 10:{const t=e;r.feedback||c(!t),t&&t!==r.feedback&&(c(t instanceof Float32Array),c(t.length===r.prevCells*r.cellSize,"Feedback's length differs from data's"),c(r.input.noData.length===r.prevCells,"Must resize `noData` back too"),c(r.input.noFeedback.length===r.prevCells,"Must resize `noFeedback` back too"),r.cells=r.prevCells,d(r.feedback),r.feedback=t),r.stage=6;continue}}}static async handleLoop(e,n,a,r){const o=s[e],i=o.shaped[r];if(!i||i.looping)return;i.looping=!0,i.prevEnd=performance.now();let l=i.prevEnd,c=i.prevEnd,u=0,d=1e4,f=!1,m=0;for(;;){if(!o.shaped[r])return;const s=i.overscheduled>.5,p=o.mainHandler&&o.mainHandler.summary===r?o.mainHandler:null;if(!i.stepsNow||!s){const e=o.cellShapes;if(e.length>1&&(!o.shaped[e[0].summary]||!o.shaped[e[0].summary].handlers.length)){const t=0,n=1+(Math.random()*(e.length-1)|0);[e[t],e[n]]=[e[n],e[t]]}if((o.mainHandler?!!p:e.length&&e[0].summary===r)&&Array.isArray(o.sensors))for(let e=0;e<o.sensors.length;++e){const t=o.sensors[e];if("function"!=typeof t.onValues)continue;const n=h(t.values);try{t.onValues.call(t,n)}catch(e){console.error(e)}}}if(!i.handlers.length||!o.sensors.length&&!i.nextPacket.sensor.length)return i.msPerStep[0]=i.msPerStep[1]=0,i.looping=!1;let g=!1;if(f=!1,!i.stepsNow||!s){const t=i.nextPacket;i.nextPacket=_Packet.init(e,n,a,r),g=!t.cells,f=i.tooFew=!1,t.mainHandler=p,t.handleStateMachine(),i.tooFew&&(f=!0),_Packet._measureThroughput()}for(;i.stepsNow>=t.maxSimultaneousPackets;)await new Promise((e=>i.waitingSinceTooManySteps=e));i.noDataDelay=g?i.noDataDelay?Math.min(1.4*i.noDataDelay,500):1:0;const y=performance.now();i.prevEnd+=i.msPerStep[1],i.prevEnd<y-500&&(i.prevEnd=y-500),i.prevEnd>y+500&&(i.prevEnd=y+500);let b=Math.max(i.prevEnd-y,i.noDataDelay),k=u>2*d+2||y-l>100||y-c>500;if(k||!f&&b>m){const e=Math.max(b-m,0),t=performance.now()+e;let n=0;await new Promise((s=>{const a=setTimeout((()=>{n||(c=performance.now(),s()),m=.75*m+.25*(performance.now()-t)}),e);k||(i.giveNextPacketNow=s,i.clearNextPacketNow=a)})),d=.95*d+.05*u,u=0,l=n=performance.now(),i.giveNextPacketNow=null,i.clearNextPacketNow=null}else++u}}static _measureThroughput(e=!1){const n=performance.now();if(_Packet.lastMeasuredThroughputAt||(_Packet.lastMeasuredThroughputAt=n,_Packet.lastMemory=f()),e||n-_Packet.lastMeasuredThroughputAt>500){const s=Math.max(n-_Packet.lastMeasuredThroughputAt,.01)/1e3;e||(t.meta.metric("throughput, bytes/s",(_Packet._handledBytes||0)/s),t.meta.metric("allocations, bytes/s",Math.max(f()-_Packet.lastMemory,0)/s)),_Packet.lastMeasuredThroughputAt=n,_Packet._handledBytes=0,_Packet.stepsEnded=0,_Packet.lastMemory=f()}}}n(t,{Sensor:n(class Sensor{constructor(e){e&&this.resume(e)}needsExtensionAPI(){return null}cellShape(){const e=y(this.channel);return e.mainHandler?e.mainHandler.cellShape:e.cellShapes[0]&&e.cellShapes[0].cellShape||null}sendRawCallback(e,t,n){c(null===e||"function"==typeof e,"Bad callback"),c("function"==typeof t),c(null==n||"function"==typeof n);const s=y(this.channel),a=Sensor._removed||(Sensor._removed=new Set);for(let r=0;r<s.cellShapes.length;++r){const{cellShape:o,partSize:i,summary:l}=s.cellShapes[r],c=s.shaped[l];if(!c.handlers.length){performance.now()-c.lastUsed>6e4&&a.add(s.cellShapes[r]);continue}const u=p(this,this.dataNamers,o,i,l),h=t.call(this,s.cellShapes[r],u,c.nextPacket,e,n);c.looping||_Packet.handleLoop(this.channel,o,i,l),h&&c.stepsNow<=1&&c.giveNextPacketNow&&(clearTimeout(c.clearNextPacketNow),c.giveNextPacketNow())}a.size&&(s.cellShapes=s.cellShapes.filter((e=>!a.has(e))),a.forEach((e=>delete s.shaped[e.summary])),a.clear())}static _unnameFeedback(e,t,n,s){const a=h(s);return e.unname(t,n,a),a}sendCallback(e,t=null,n=null,s=0){c(null===t||t instanceof Float32Array),c(null===n||n instanceof Float32Array),t&&c(t.length===this.values,"Data size differs from the one in options"),n&&c(t&&t.length===n.length),this.sendRawCallback(e,(function({cellShape:e,partSize:a,summary:r},o,i,l,c){const u=h(o.namedSize),d=n?h(o.namedSize):null;return t||u.fill(0),u&&o.name(t,u,0,s),d&&o.name(n,d,0,0,-1),i.send(this,l,c,u,d,null===t,this.noFeedback),!!t}),Sensor._unnameFeedback),t&&d(t),n&&d(n)}send(e,t=null,n=0){return new Promise(((s,a)=>{try{this.sendCallback(s,e,t,n)}catch(e){a(e)}}))}resize(e,t=null){null==t&&(t=this.emptyValues);if(this.values===e)return;const n=this.dataNamers,s=Object.create(null);for(let a of Object.keys(n))s[a]=n[a].resized(e,t);this.values=e,this.emptyValues=t,this.dataNamers=s}pause(e=!1){if(!1!==this.paused)return this;this.paused=!0;const t=y(this.channel);return t.sensors=t.sensors.filter((e=>e!==this)),this}resume(e){if(e){this.pause(!0);const{name:t,values:n,onValues:s=null,channel:a="",noFeedback:r=!1,userName:o=[],emptyValues:i=0,hasher:u}=e;c("string"==typeof t||Array.isArray(t),"Must have a name"),l("Must have the value-count",n),c(null==s||"function"==typeof s),c("string"==typeof a),c("string"==typeof o||Array.isArray(o)),l("",i),c(void 0===u||"function"==typeof u),Object.assign(this,{paused:!0,reward:0,name:t,values:n,onValues:s,channel:a,noFeedback:!!r,userName:o,emptyValues:i,hasher:u,dataNamers:Object.create(null),partSize:0,userParts:0,nameParts:0,dataSize:0}),this.feedbackCallbacks||(this.feedbackCallbacks=[],this.feedbackNoFeedback=[],this.feedbackNamers=[],this.feedbackUnnamer=[])}if(!this.paused)return this;this.paused=!1;const t=y(this.channel);t.sensors.push(this);for(let{cellShape:e,partSize:n,summary:s}of t.cellShapes)_Packet.handleLoop(this.channel,e,n,s);return this}},{docs:"Generalization of eyes and ears and hands, hotswappable and adjustable.\n\n- `constructor({ name, values, onValues=null, channel='', noFeedback=false, userName=[], emptyValues=0, hasher=… })`\n    - `name`: a human-readable string, or an array of that or a -1…1 number or a function from `dataStart, dataEnd, dataLen` to a -1…1 number.\n    - `values`: how many -1…1 numbers this sensor exposes.\n        - Usually a good idea to keep this to powers-of-2, and squares. Such as 64.\n    - `onValues.call(sensor, data)`: the regularly-executed function that reports data, by calling `sensor.send(data, …)` inside once.\n        - To not allocate garbage, use `sensor.sendCallback(then, data, …)` with a static function.\n        - `data` is owned; `sensor.send` it only once, or `sn._deallocF32(data)` if unused.\n    - Extra flexibility:\n        - `channel`: the human-readable name of the channel. Communication only happens within the same channel.\n        - `noFeedback`: set to `true` if applicable to avoid some processing. Otherwise, feedback is the data that should have been.\n        - `userName`: the name of the machine that sources data. Makes it possible to reliably distinguish sources.\n        - `emptyValues`: the guaranteed extra padding, for fractal folding. See `sn._dataNamer.fill`.\n        - `hasher(…)(…)(…)`: see `sn._dataNamer.hasher`. The default mainly hashes strings in `userName`/`name` with MD5 and rescales bytes into -1…1.\n    - To change any of this, `resume({…})`.\n\n- `cellShape() → [user, name, data] | null`: returns the target's cell shape. Note that this may change rarely.\n\n- `send(values = null, error = null, reward = 0) → Promise<null|feedback>`\n    - (Do not override in child classes, only call.)\n    - `values`: `null` or owned flat data, -1…1 `Float32Array`. Do not perform ANY operations on it once called.\n        - (`null` means \"feedback only please\", meaning, actions.)\n        - To mitigate misalignment, try to stick to powers of 2 in all sizes.\n        - (Can use `sn._allocF32(len)` for efficient reuse.)\n    - `error`: `null` or owned flat data, -1…1 `Float32Array` of length `values.length`: `max abs(truth - observation) - 1`. Do not perform ANY operations on it once called.\n    - `reward`: every sensor can tell handlers what to maximize, -1…1. (What is closest in meaning for you? Localized pain and pleasure? Satisfying everyone's needs rather than the handler's? …Money? Either way, it sounds like a proper body.)\n        - Can be a number or a per-cell array or a function from `valueStart, valueEnd, valuesTotal` to that.\n    - (Result: `feedback` is owned by you. Can use `feedback && sn._deallocF32(feedback)` once you are done with it, or simply ignore it and let GC collect it.)\n\n- `sendCallback(then.call(sensor, null|feedback, cellShape, partSize), values, error = null, reward = 0)`: exactly like `send` but does not have to allocate a promise, which is more efficient.\n\n- `resize(newValues, newEmptyValues = emptyValues)`: fast changing of flat-data length.\n    - (If used in `onValues`, do `sn._deallocF32(data), data = sn._allocF32(newValues)` for efficiency.)\n\n- `pause()`, `resume(opts?)`: for convenience, these return the object.\n\n- `needsExtensionAPI() → null|String`: overridable in child classes. By default, the sensor is entirely in-page in a [content script](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts) if injected by an extension. For example, make this return `'tabs'` to get access to [`chrome.tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) in an extension."}),Transform:n(class Transform{constructor(e){e&&this.resume(e)}pause(e=!1){if(!1!==this.paused)return this;const t=y(this.channel);return t.transforms=t.transforms.filter((e=>e!==this)),this.paused=!0,this}resume(e){if(e){this.pause(!0);const{onValues:t=null,onFeedback:n=null,priority:s=0,channel:a=""}=e;c("number"==typeof s&&s==s,"Bad `priority`"),c(null==t||"function"==typeof t,"Bad `onValues`"),c(null==n||"function"==typeof n,"Bad `onFeedback`"),c(t||n,"Why have a transform if it does nothing? Pass in either `onValues` or `onFeedback`"),c("string"==typeof a,"Bad `channel`"),Object.assign(this,{paused:!0,onValues:t,onFeedback:n,priority:s,channel:a})}if(!this.paused)return this;const t=y(this.channel);return t.transforms.push(this),t.transforms.sort(((e,t)=>t.priority-e.priority)),this.paused=!1,this}},{docs:"Modifies data/feedback, after sensors and before handlers.\n\n- `constructor({ onValues=null, onFeedback=null, priority=0, channel='' })`\n    - Needs one or both:\n        - `onValues(then, {data, error, noData, noFeedback, cellShape, partSize})`: can modify `data` and the optional `error` in-place.\n            - ALWAYS do `then(extra, …)`, at the end, even on errors. `extra` will be seen by `onFeedback` if specified.\n                - To resize `data` and possibly `error`, pass the next version (`._allocF32(len)`) to `then(extra, data2)` or `then(extra, data2, error2)`; also resize `noData` and `noFeedback`; do not deallocate arguments.\n            - `cellShape: [user, name, data]`\n            - Data is split into cells, each made up of `cellShape.reduce((a,b)=>a+b)` -1…1 numbers.\n            - `noData` and `noFeedback` are JS arrays, from cell index to boolean.\n        - `onFeedback(then, {data, error, noData, noFeedback, cellShape, partSize}, feedback, extra)`: can modify `feedback` in-place.\n            - ALWAYS do `then()`, at the end, even on errors.\n                - If `data` was resized and `feedback` was given, must resize it back, by passing the next version (`._allocF32(len)`) to `then(feedback)`; do not deallocate arguments.\n    - Extra flexibility:\n        - `priority`: transforms run in order, highest priority first.\n        - `channel`: the human-readable name of the channel. Communication only happens within the same channel.\n    - To change any of this, `resume({…})`.\n\n- `pause()`, `resume(opts?)`: for convenience, these return the object."}),Handler:n(class Handler{constructor(e){e&&this.resume(e)}pause(e=!1){if(!1!==this.paused)return this;const t=y(this.channel),n=y(this.channel,this.cellShape,this.partSize,this.summary);if(n.handlers=n.handlers.filter((e=>e!==this)),t.mainHandler===this){t.mainHandler=null;for(let{cellShape:e,partSize:n,summary:s}of t.cellShapes)for(let e of t.shaped[s].handlers)!e.noFeedback&&(null==t.mainHandler||t.mainHandler.priority<e.priority)&&(t.mainHandler=e)}return this.paused=!0,this}resume(e){if(e){this.pause(!0);const{onValues:t,partSize:n=8,userParts:s=1,nameParts:a=3,dataSize:r=64,noFeedback:o=!1,priority:i=0,channel:u=""}=e;c("function"==typeof t,"Handlers must have `onValues` listeners"),l("",n,s,a,r),c("number"==typeof i),c("string"==typeof u);const h=[s*n,a*n,r];Object.assign(this,{paused:!0,partSize:n,cellShape:h,summary:g(h,n),onValues:t,noFeedback:!!o,priority:i,channel:u})}if(!this.paused)return this;const t=y(this.channel),n=y(this.channel,this.cellShape,this.partSize,this.summary);return n.handlers.push(this),n.handlers.sort(((e,t)=>t.priority-e.priority)),!this.noFeedback&&(null==t.mainHandler||t.mainHandler.priority<this.priority)&&(t.mainHandler=this),this.paused=!1,this.onValues&&_Packet.handleLoop(this.channel,this.cellShape,this.partSize,this.summary),this}},{docs:"Given data, gives feedback: is a human or AI model.\n\n- `constructor({ onValues, partSize=8, userParts=1, nameParts=3, dataSize=64, noFeedback=false, priority=0, channel='' })`\n    - `onValues(then, {data, error, noData, noFeedback, cellShape, partSize}, feedback)`: process.\n        - ALWAYS do `then()` when done, even on errors.\n            - If you stall artificially to maintain tempo (as `sn.Handler.Sound` does), pass in how many milliseconds you've stalled for.\n        - `feedback` is available in the one main handler, which should write to it in-place.\n            - In other handlers, data of `noData` cells will be replaced by feedback.\n        - `noData` and `noFeedback` are JS arrays, from cell index to boolean.\n        - `data` and `error` are not owned; do not write. `error` and `feedback` can be `null`s.\n    - Cell sizes:\n        - `partSize`: how many numbers each part in the cell ID takes up, where each string in a name takes up a whole part:\n            - `userParts`\n            - `nameParts`\n        - `dataSize`: numbers in the data segment.\n    - Extra flexibility:\n        - `noFeedback`: can't provide feedback if `true`, only observe it.\n        - `priority`: the highest-priority handler without `noFeedback` will be the *main* handler, and give feedback.\n        - `channel`: the human-readable name of the channel. Communication only happens within the same channel.\n    - To change any of this, `resume({…})`.\n\n- `pause()`, `resume(opts?)`: for convenience, these return the object.",options:()=>({partSize:{"8 ":()=>8,"4 ":()=>4,"16 ":()=>16,"32 ":()=>32},userParts:{"×1":()=>1,"×0":()=>0},nameParts:{"×3":()=>3,"×2":()=>2,"×1":()=>1,"×0":()=>0,"×5":()=>5},dataSize:{"+64":()=>64,"+16":()=>16,"+256":()=>256}}),bench:()=>new Array(10).fill().map(((e,t)=>10*(t+1))).map((function(e){function n(e){e&&(e.fill(.5439828952837),t._deallocF32(e))}return function(){const s=new t.Sensor({name:["some","kinda","name"],values:64*e,onValues(e){e.fill(1),this.sendCallback(n,e)}}),a=new t.Handler({dataSize:64,onValues(e,{data:t,error:n,cellShape:s},a){try{t.fill(.489018922485),a&&a.fill(-1)}finally{e()}}});return function(){s.pause(),a.pause()}}}))}),_allocF32:h,_deallocF32:d,_assert:c,_assertCounts:l,maxSimultaneousPackets:16,meta:{docs:n((function e(){const n=[],s=function t(s,r,o="sn"){if(!s||"object"!=typeof s&&"function"!=typeof s)return;let i=!1;const l=n.push(`<a id="${a(o)}"></a>\n`+"#".repeat(r+1)+" `"+o+"`[ ↑](#toc)")-1;if("string"==typeof s.docs||"function"==typeof s.docs&&s.docs!==e){const e="function"==typeof s.docs?s.docs():s.docs,t=function(e){if("function"!=typeof e||"class "===String(e).slice(0,6))return;const t=String(e).indexOf(" {");return t<0?void 0:String(e).slice(0,t)}(s);t&&n.push("```js\n"+t+"\n```"),n.push(e),i=!0}let c=null;for(let e of Object.keys(s)){if("_"===e[0])continue;const n=o+"."+e,a=t(s[e],r+1,n);a&&((c||(c=Object.create(null)))[n]=a)}c||i||(n[l]="");return c||i}(t,0);return n.unshift("<a id=toc></a>\n# Table of contents","Sensor network:",...function e(t,n=0,s=[]){if(t&&!0!==t)for(let r of Object.keys(t))s.push("    ".repeat(n)+`- [${r}](#${a(r)})`),e(t[r],n+1,s);return s}(s)),n.filter((e=>e)).join("\n\n");function a(e){return e.toLowerCase().replace(/[^a-zA-Z0-9]/g,"-")}}),{docs:"Returns the Markdown string containing all the sensor network's documentation.\n\nObjects need to define `.docs` to be either a string or a function to that."}),tests:n((async function e(){const n=[];return await async function t(s){if(!s||"object"!=typeof s&&"function"!=typeof s)return;if("function"==typeof s.tests&&s.tests!==e)try{for(let[e,t,a]of await s.tests())""+t!=""+a&&n.push([e,t,a])}catch(e){n.push(e instanceof Error?[s.name||"—",e.message,e.stack]:[s.name||"—",!s||"object"!=typeof s&&"function"!=typeof s?""+s:"<Error>"])}return Promise.all(Object.values(s).map(t))}(t),n.length?n:null}),{docs:"Runs all sensor-network tests, and returns `null` if OK, else an array of `[failedTestName, value1, value2]`.\n\nIf not `null`, things are very wrong.\n\nInternally, it calls `.tests()` which return `[…, [testName, value1, value2], …]`. String representations must match exactly to succeed."}),metric:n((function(e,t){if(a)if("string"==typeof t)a[e]=t;else if("number"==typeof t){if(t!=t||!isFinite(t))return;!Array.isArray(a[e])&&(a[e]=[]),a[e].push(t)}else u("what this: "+t)}),{docs:"Call this with a string key & string/number value to display/measure something, if `E.meta.bench` controls execution."}),bench:n((async function(e=30,n=null,s=null){c("number"==typeof e);const r=Object.create(null);"function"!=typeof s&&(s=(e,t,n,s)=>{if(!e)return;const a=e.name||"—",o=r[a]||(r[a]=Object.create(null));for(let e of Object.keys(n)){let s=n[e];Array.isArray(s)&&(s=s.reduce(((e,t)=>e+t))/s.length),o[e][t]=s}});const o=[],i=[],l=[];!function e(s){if(!s||"object"!=typeof s&&"function"!=typeof s)return;if(Object.prototype.hasOwnProperty.call(s,"bench")&&"function"==typeof s.bench&&s.bench!==t.meta.bench){const e=s.bench();for(let t of Object.keys(e))("function"!=typeof n||n(s))&&(o.push(e[t]),i.push(t),l.push(s))}return Object.values(s).map(e)}(t);for(let t=0;t<o.length;++t)try{const n=a=Object.create(null),r=o[t].call();c("function"==typeof r,"BUT HOW DO WE STOP THIS"),_Packet._measureThroughput(!0),await new Promise(((t,n)=>setTimeout((()=>{try{t(r())}catch(e){n(e)}}),1e3*e))),_Packet._measureThroughput(!0),a=null,s(l[t],i[t],n,(t+1)/o.length)}catch(e){console.error(e)}return s(null,null,null,1),a=null,Object.keys(r).length?r:void 0}),{docs:"Very slowly, runs all sensor-network benchmarks.\n\nCan `JSON.stringify` the result: `{ …, .name:{ …, key:[...values], … }, … }`.\n\nArguments:\n- `secPerBenchmark = 30`: how many seconds each step should last.\n- `benchFilter(obj) = null`: return `true` to process a benchmark, else skip it.\n- `onBenchFinished(obj, id, { …, key: String | [...values], …}, progress) = null`: the optional callback. If specified, there is no result.\n\nNote that [Firefox and Safari don't support measuring memory](https://developer.mozilla.org/en-US/docs/Web/API/Performance/memory).\n\nBenchmarks are contained in `.bench()` near to code that they benchmark. Report metrics via `E.meta.metric(key, value)`.\nThose methods return objects (such as arrays) that contain start functions, which return stop functions.\n"})},_dataNamer:n((function({userName:e=[],userParts:n=1,nameParts:s=3,partSize:a=8,name:r,values:o,emptyValues:i=0,dataSize:u=64,hasher:h=t._dataNamer.hasher}){l("",n,s,a);const d=h(r,s,a),f=h(e,n,a),m=(n+s)*a+u;return function e(r,o){const i=Math.ceil((o+r)/u),l=Math.ceil(r/i),h=f(0,n*a,n*a),p=new Array(i);for(let e=0;e<i;++e)p[e]=d(e*l,Math.min((e+1)*l,r),r);return{cells:i,namedSize:i*m,cellShape:[n*a,s*a,u],name(e,o,d,f=0,g=null){for(let y=0;y<i;++y){const i=d+y*m,b=i+(n+s)*a;if(null==g){h(o,i),p[y](o,i+n*a);const e="number"==typeof f?f:Array.isArray(f)?f[y]:f(y*l,Math.min((y+1)*l,r),r);c(e>=-1&&e<=1),o[i]=e}else o.fill(g,i,b);if(e){const t=y*l,n=Math.min(t+l,e.length);for(let s=t,a=b;s<n;++s,++a)o[a]=e[s]}t._dataNamer.fill(o,b,l,u)}return d+i*m},unname(e,r,o){if(e)for(let c=0;c<i;++c){const i=r+c*m+(n+s)*a;t._dataNamer.unfill(e,i,l,u);const h=c*l,d=Math.min(h+l,o.length);for(let t=i,n=h;n<d;++t,++n)o[n]=e[t]}return r+i*m},resized:(t,n=o)=>e(t,n)}}(o,i)}),{docs:'Implementation detail.\n\nPrepares to go between flat number arrays and named ones.\n\n- The result is `{ cells, namedSize, cellShape, name(src, dst, dstOffset, reward=0, skipNonData=null)→dstOffset, unname(src, srcOffset, dst)→srcOffset, resized(values, emptyValues=…)→nextVersion }`. `name` goes from flat to named, `unname` reverses this.\n    - `reward` is either a -1…1 number or a function from `valueStart, valueEnd, valuesTotal` to that.\n    - If `skipNonData` is a -1…1 number, the non-data portions of each cell are replaced with that. (This is for "naming" data error with "no errors here".)\n\nMain parameters, in the one object that serves as arguments:\n- `name`: describes this interface to handlers, such as with a string. See `sn._dataNamer.hasher`.\n- `values`: how many flat numbers there will be.\n\nExtra parameters:\n- `userName = []`: describes the current user/source/machine to handlers, mainly for when the sensor network encompasses multiple devices across the Internet.\n- Cell sizes:\n    - `partSize = 8`:\n        - `userParts = 1`\n        - `nameParts = 3`\n    - `dataSize = 64`\n- `emptyValues = 0`: how many fake `values` to insert, so that values are fractally folded more; see `sn._dataNamer.fill`.\n- `hasher = sn._dataNamer.hasher`: defines how names are transformed into `-1`…`1` numbers.\n',tests(){const e=Float32Array,n=new e(12);return[["Fractal-filling values",new e([0,.97,-.5,-.25,0,.5,0,.97,.25,.5,.5,0]),s(new e([-.5,-.25,.25,.5]),{name:"z",values:4,emptyValues:1,dataSize:4,partSize:1,userParts:1,nameParts:1})],["Fractal-filling names",new e([0,0,0,0,.13,.74,-.48,.04,-.5,-.25,.25,.5]),s(new e([-.5,-.25,.25,.5]),{name:[.13],values:4,dataSize:4,partSize:4,userParts:1,nameParts:1})],["Filling names, but there are too many strings so `.14` numbers move in",new e([0,-.91,.14,.5,.25,0]),s(new e([.5,.25,0]),{name:["a","b","c",.14],values:3,dataSize:3,partSize:1,userParts:1,nameParts:2})],a(1023),a(1024),a(1025)];function s(e,s){return function(e,...t){try{return e(...t)}catch(e){return e instanceof Error?[e.message,e.stack]:e}}((s=>{const a=t._dataNamer(s);return a.name(e,n,0),n.subarray(0,a.namedSize).map(r)}),s)}function a(n){const s=new e(n),a=new e(n);for(let e=0;e<n;++e)s[e]=2*Math.random()-1;const o={name:"matters not",values:n,dataSize:64,partSize:16,userParts:1,nameParts:3},i=t._dataNamer(o),l=new e(128*i.cells);return i.name(s,l,0),i.unname(l,0,a),["Name+unname for "+n,s.map(r),a.map(r)]}function r(e){return Math.round(100*e)/100}},hasher:n((function(e,n,s){let a=[],r=!1,o=null,i=!0;if(function e(t){if(Array.isArray(t))t.forEach(e);else if("string"==typeof t){const e=self.YaMD5.hashStr(t,!0),n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),o=new Array(Math.min(n.length,s));for(let e=0;e<o.length;++e)o[e]=n[e]/255*2-1;a.push(o),r=!1}else"number"==typeof t||"function"==typeof t?("number"==typeof t&&(t!=t||t<-1||t>1)&&u("NAME parts must be -1..1, got",t),(!r||a[a.length-1].length>=s)&&(a.push([]),r=!0),null==o&&(o=a.length-1),"function"==typeof t&&(i=!1),a[a.length-1].push(t)):u("Unrecognized name part:",t)}(e),e=null,i){const e=l(new Float32Array(n*s));return function(...t){return function(t,n){t.set(e,n)}}}return function(...e){const t=l(new Float32Array(n*s),...e);return function(e,n){e.set(t,n)}};function l(e,...r){let i=a.slice();const l=Math.min(i.length,n);null!=o&&o>=l&&i.splice(l-1,o-(l-1));for(let n=0;n<l;++n){const a=i[n];for(let t=0;t<a.length;++t){let o=a[t];"function"==typeof o&&(o=o(...r),("number"!=typeof o||o!=o||o<-1||o>1)&&u("Name parts must be -1…1, got",o)),e[n*s+t]=o}t._dataNamer.fill(e,n*s,a.length,s)}return i.length?t._dataNamer.fill(e,0,l*s,e.length):e.fill(0,e.length),e}}),{docs:"Creates a function that allocates `name` into `partCount` parts, each with `partSize` numbers.\n\nThe result takes `dataStart, dataEnd, dataLen` (for filling function values) and returns a closure, which takes `dst` and `dstOffset`, and will write `partCount * partSize` -1..1 f32 numbers there when called.\n\n`name`:\n- A string. Hashed with MD5 and put in byte-by-byte into one part, rescaled to `-1`…`1`.\n- A number, `-1`…`1`.\n- A number-returning function, given `dataStart, dataEnd, dataLen`.\n- An array of these."}),fill:n((function(e,t,n,s){if(!(n>=s)&&n)for(let a=t+n;a<t+s;++a)e[a]=1-2*Math.abs(e[a-n])}),{docs:"Where there is free space, this will put an end to it.\n\nIncreases sensitivity to variations, by fractally folding available values onto free space via `x → 1-2*abs(x)`.\n\nEven if your AI model can only accept and return ±1 bits, it can still use the Sensor Network by having lots of free space (`emptyValues` in `._dataNamer`)."}),unfill:n((function(e,t,n,s){if(!(n>=s)&&n){for(let a=t+s-n-1;a>=t;--a)e[a]=Math.sign(e[a])*Math.abs(e[a+n]-1)*.5;return e}}),{docs:"Reverses `._dataNamer.fill`, enhancing low-frequency numbers with best guesses from high-frequency numbers.\n\nMakes only the sign matter for low-frequency numbers."})})}),t.meta.UI=init$a(t);const o=init$3(t),i=init(t);return Object.assign(t.Sensor,{Text:init$9(t),Video:init$c(t),Audio:init$6(t),Keyboard:init$4(t),Pointer:init$5(t),Scroll:init$7(t),Storage:i.sensor,Internet:o.sensor}),Object.assign(t.Transform,{Time:init$1(t),Reward:init$b(t),LimitFPS:init$2(t)}),Object.assign(t.Handler,{Sound:init$d(t),Storage:i.handler,Internet:o.handler,Random:init$8(t)}),t;function l(e,...t){c(t.every((e=>"number"==typeof e&&e>=0&&e===e>>>0)),e||"Must be a non-negative integer")}function c(e,t){e||u(t||"Assertion failed")}function u(...e){throw new Error(e.join(" "))}function h(e){const t=r[e];return t&&t.length?t.pop():new Float32Array(e)}function d(e){c(e instanceof Float32Array);const t=e.length;r[t]||(r[t]=[]);const n=r[t];n.length<16&&n.push(e)}function f(){return performance.memory?performance.memory.usedJSHeapSize:NaN}function m(e,t,n,s,a,r,o,i){try{const l=e.feedbackCallbacks.shift(),c=e.feedbackNoFeedback.shift(),u=e.feedbackNamers.shift(),h=e.feedbackUnnamer.shift();if(s&&!c){const n=p(e,u,r,o,i),c=h&&h(n,s,a,t.length);l&&l.call(e,c,r,o)}else l&&l.call(e,null,r,o)}finally{d(t),n&&d(n)}}function p(e,n,s,a,r){if(!n[r]){const[o,i,l]=s;e.partSize=a,e.userParts=o/a|0,e.nameParts=i/a|0,e.dataSize=l,n[r]=t._dataNamer(e)}return n[r]}function g(e,t){return t+":"+e}function y(e,t,n,a=t&&g(t,n)){s[e]||(s[e]=Object.assign(Object.create(null),{sensors:[],transforms:[],mainHandler:null,cellShapes:[],shaped:Object.create(null),prevEnd:0}));const r=s[e];return null==t?r:(r.shaped[a]||(r.shaped[a]={partSize:n,looping:!1,stepsNow:0,overscheduled:0,lastUsed:performance.now(),giveNextPacketNow:null,clearNextPacketNow:null,waitingSinceTooManySteps:null,msPerStep:[0,0],cellShape:t,handlers:[],nextPacket:null,packetCache:[],tooFew:!1,noDataDelay:0},r.shaped[a].nextPacket=new _Packet(e,t,n,a),r.cellShapes.push({cellShape:t,partSize:n,summary:a})),r.shaped[a])}}();export{main as default};